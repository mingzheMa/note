import{_ as p}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as e,c as o,a as s,b as n,e as c,d as a,r as l}from"./app.002a81c8.js";const i="/note/assets/esbuild.633eb283.png",u={},r=a(`<h1 id="项目构建相关" tabindex="-1"><a class="header-anchor" href="#项目构建相关" aria-hidden="true">#</a> 项目构建相关</h1><p>这里并不探讨vue3的源码，只是为了学习vue3项目构建中使用的一些技术</p><h2 id="monorepo-仓库管理方式" tabindex="-1"><a class="header-anchor" href="#monorepo-仓库管理方式" aria-hidden="true">#</a> monorepo 仓库管理方式</h2><p>vue3使用的是 <strong>monorepo</strong> 和 <strong>TypeScript</strong> 管理和开发代码，monorepo解释为单体仓库（mono repo），将耦合度高或依赖性强的项目整合到一个仓库下，通过人为的规则将这些项目划分开</p><p>vue3目录如下，将各个功能拆分出单个项目，都放在 <code>vue3/core/packages</code> 中</p><div class="language-txt line-numbers-mode" data-ext="txt"><pre class="language-txt"><code>vue3/core
├── packages
│   ├── compiler-core
│   ├── compiler-dom
│   ├── compiler-sfc
│   ├── compiler-ssr
│   ├── reactivity
│   ├── reactivity-transform
│   ├── runtime-core
│   ├── runtime-dom
│   ├── runtime-test
│   ├── server-renderer
│   ├── sfc-playground
│   ├── shared
│   ├── size-check
│   ├── template-explorer
│   ├── vue
└── └── vue-compat
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="monorepo-和-multirepos" tabindex="-1"><a class="header-anchor" href="#monorepo-和-multirepos" aria-hidden="true">#</a> monorepo 和 multirepos</h3><p><strong>multirepos</strong> 是多体仓库，这是比较常用的管理方式，每一个仓库下只存放该项目的代码</p><p>从multirepos迁移到monorepo，就是将所有仓库都合并在一起</p><div class="language-txt line-numbers-mode" data-ext="txt"><pre class="language-txt"><code>/project1
/project2
/project3

↑ 合并为 ↓

/monorepo/project/project1
/monorepo/project/project2
/monorepo/project/project3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="monorepo-优点" tabindex="-1"><a class="header-anchor" href="#monorepo-优点" aria-hidden="true">#</a> monorepo 优点</h3><ul><li><strong>代码透明</strong>，业务相关的项目都在一个仓库中，使得某个项目组可以观察到所有项目的代码，更好的团队协作</li><li><strong>更好的依赖管理</strong>，一些公共库不需要包管理工具，直接根据路径导入</li><li><strong>版本冲突</strong>，由于公共库直接导入使用，所以该项目使用的公共库一直是最新版本，减少版本冲突</li><li><strong>代码风格</strong>，有利于统一整个代码风格</li><li><strong>重大更新</strong>，某个项目有重大变更其他的项目组在拉取代码时可以观察到，如果与变更项目依赖部分产生影响能及时发现</li><li><strong>重构或更新</strong>，如果一个业务穿插多个项目，可以在一个分支中完成</li><li><strong>CI/CD</strong>，可以使用同一套CI/CD部署</li></ul><h3 id="monorepo-缺点" tabindex="-1"><a class="header-anchor" href="#monorepo-缺点" aria-hidden="true">#</a> monorepo 缺点</h3><ul><li><strong>仓库庞大</strong>，一些全局的命令会非常耗时，例如：git pull</li><li><strong>污染主分支</strong>，如果一个问题分支合并到主分支上，可能会影响所有项目，比较考验开发和审核的规则以及相关人员的素质</li><li><strong>commit增多审查困难</strong>，合并仓库就会导致commit增多，导致code review困难</li><li><strong>权限管理</strong>，gitHub并没有仓库下文件的管理系统</li></ul><h3 id="monorepo-最佳实践" tabindex="-1"><a class="header-anchor" href="#monorepo-最佳实践" aria-hidden="true">#</a> monorepo 最佳实践</h3><ul><li>规范仓库中项目目录，便于查找</li><li>尽量保持分支的纯净</li><li>一次性提升所有依赖，减少出现版本冲突的情况</li><li>git中使用浅克隆和分支过滤处理仓库</li><li>使用一些monorepo管理器，例如：lerna</li></ul><h2 id="vue3-构建结果" tabindex="-1"><a class="header-anchor" href="#vue3-构建结果" aria-hidden="true">#</a> Vue3 构建结果</h2><p>仓库中 Vue 项目就是整个 vue 包的入口，目录为 <code>vue3/core/packages/vue</code>，可以使用仓库根目录下的命令 <code>pnpm build</code> 对仓库中每个项目进行打包，打包后在 <code>vue3/core/packages/vue/dist</code> 中可以看到 vue 包的所有版本</p><div class="language-txt line-numbers-mode" data-ext="txt"><pre class="language-txt"><code>vue3/core/packages/vue/dist
├── vue.cjs.js
├── vue.cjs.prod.js
├── vue.d.ts
├── vue.esm-browser.js
├── vue.esm-browser.prod.js
├── vue.esm-bundler.js
├── vue.global.js
├── vue.global.prod.js
├── vue.runtime.esm-browser.js
├── vue.runtime.esm-browser.prod.js
├── vue.runtime.esm-bundler.js
├── vue.runtime.global.js
└── vue.runtime.global.prod.js
</code></pre><div class="highlight-lines"><br><div class="highlight-line"> </div><br><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>除了TS声明文件 <code>.d.ts</code> 和 压缩后的代码 <code>.prod.js</code> 文件剩下的有7个版本</p><ul><li><code>vue.cjs.js</code>，commonJS模块的版本</li><li><code>vue.esm-browser.js</code>，用于浏览器原生ES模块导入的版本，例如：<code>&lt;script type=&quot;module&quot;&gt;</code></li><li><code>vue.esm-bundler.js</code>，在构建工具中使用原声模块导入的版本</li><li><code>vue.global.js</code>，全局变量的版本，用于cdn引入</li></ul><p><code>vue.runtime.xxx.js</code>，为各个版本的运行时版，是没有编译器部分代码，因为在构建工具中可以使用 <code>vue-loader</code> 来完成编译，这样可以减少代码包体积。上面这些为完全版，是带有编译器部分的代码</p><blockquote><p>编译器是将模板转化成渲染函数，例如：&lt;div&gt;123&lt;/div&gt; =&gt; h(&quot;div&quot;, &quot;123&quot;)</p></blockquote><h2 id="esbuild-打包" tabindex="-1"><a class="header-anchor" href="#esbuild-打包" aria-hidden="true">#</a> esbuild 打包</h2><p>在vue3开发阶段使用的就是esbuild打包</p><h3 id="esbuild-特点" tabindex="-1"><a class="header-anchor" href="#esbuild-特点" aria-hidden="true">#</a> esbuild 特点</h3><p><img src="`+i+`" alt=""></p><p>esbuild是js打包工具，主要针对esm，其速度是webpack的很多倍，功能如下：</p><ul><li>极快的速度，无需缓存</li><li>支持 ES6 和 CommonJS 模块</li><li>支持对 ES6 模块进行 tree shaking</li><li>API 可同时用于 JavaScript 和 Go</li><li>兼容 TypeScript 和 JSX 语法</li><li>支持 Source maps</li><li>支持 Minification</li><li>支持 plugins</li></ul><p>为什么这么快（暂时不研究只做了解）</p><ul><li>Go语言编写，比JavaScript运行效率更高（据说JS是毫秒级，Go是纳秒级）</li><li>代码都是官方编写，没有使用第三方依赖，更方便优化性能</li><li>避免不需要的内存分配</li></ul><h3 id="在vue3中的应用" tabindex="-1"><a class="header-anchor" href="#在vue3中的应用" aria-hidden="true">#</a> 在vue3中的应用</h3><p>vue3的开发中用到了esbuild打包</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;private&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3.2.45&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;packageManager&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pnpm@7.1.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node scripts/dev.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>vue3仓库中的 <code>package.json</code> 中有两个命令，<code>dev</code> 和 <code>dev-esm</code> 都是运行开发构建，它们都运行了 <code>scripts/dev.js</code> 脚本</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// @ts-check</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> build <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;esbuild&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 使用esbuild打包</span>
<span class="token keyword">const</span> nodePolyfills <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@esbuild-plugins/node-modules-polyfill&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 如果是node环境打包需要导入node内置模块</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> resolve<span class="token punctuation">,</span> relative <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;minimist&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 解析出命令行参数</span>

<span class="token keyword">const</span> target <span class="token operator">=</span> args<span class="token punctuation">.</span>_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">&#39;vue&#39;</span> <span class="token comment">// 参数中需要打包的项目</span>
<span class="token keyword">const</span> format <span class="token operator">=</span> args<span class="token punctuation">.</span>f <span class="token operator">||</span> <span class="token string">&#39;global&#39;</span> <span class="token comment">// 打包的版本（cjs、esm-browser、esm-bundler、global）</span>
<span class="token keyword">const</span> inlineDeps <span class="token operator">=</span> args<span class="token punctuation">.</span>i <span class="token operator">||</span> args<span class="token punctuation">.</span>inline <span class="token comment">// 项目是否是内联的，如果是内联的则在打包的时候将一些库参与打包</span>
<span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">../packages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/package.json</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 需要打包项目的package.json</span>

<span class="token comment">// 标准化打包结果配置，针对cjs、esm-browser、esm-bundler、global版本、</span>
<span class="token keyword">const</span> outputFormat <span class="token operator">=</span> format<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;global&#39;</span><span class="token punctuation">)</span> 
  <span class="token operator">?</span> <span class="token string">&#39;iife&#39;</span> <span class="token comment">// 如果是global版本则打包配置是立即执行函数</span>
  <span class="token operator">:</span> format <span class="token operator">===</span> <span class="token string">&#39;cjs&#39;</span>
  <span class="token operator">?</span> <span class="token string">&#39;cjs&#39;</span> <span class="token comment">// 如果是commonJS版本</span>
  <span class="token operator">:</span> <span class="token string">&#39;esm&#39;</span> <span class="token comment">// 如果是ESModule版本</span>

<span class="token comment">// 标准化打包结果配置，针对运行时版和完全版</span>
<span class="token keyword">const</span> postfix <span class="token operator">=</span> format<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&#39;-runtime&#39;</span><span class="token punctuation">)</span>
  <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">runtime.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>format<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">-runtime$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span>
  <span class="token operator">:</span> format

<span class="token comment">// 构建输出文件配置</span>
<span class="token keyword">const</span> outfile <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>
  __dirname<span class="token punctuation">,</span>
  <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">../packages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/dist/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>
    target <span class="token operator">===</span> <span class="token string">&#39;vue-compat&#39;</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">vue</span><span class="token template-punctuation string">\`</span></span> <span class="token operator">:</span> target
  <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>postfix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">\`</span></span>
<span class="token punctuation">)</span>

<span class="token comment">// 构建报错信息，构建结果的文件路径</span>
<span class="token keyword">const</span> relativeOutfile <span class="token operator">=</span> <span class="token function">relative</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> outfile<span class="token punctuation">)</span>

<span class="token keyword">let</span> external <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 配置不参与打包的库，但是导入语句会保留</span>

<span class="token comment">// 启用打包</span>
<span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">entryPoints</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">../packages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/src/index.ts</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 打包入口设置为当前需要打包的项目</span>
  outfile<span class="token punctuation">,</span> <span class="token comment">// 输出目录为打包项目中的dist文件夹</span>
  <span class="token literal-property property">bundle</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 将依赖文件打包成一个文件</span>
  external<span class="token punctuation">,</span> <span class="token comment">// 打包结果中排除某些文件，但是保留导入语句</span>
  <span class="token literal-property property">sourcemap</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 源码地图</span>
  <span class="token literal-property property">format</span><span class="token operator">:</span> outputFormat<span class="token punctuation">,</span> <span class="token comment">// 打包的模块规则</span>
  <span class="token literal-property property">globalName</span><span class="token operator">:</span> pkg<span class="token punctuation">.</span>buildOptions<span class="token operator">?.</span>name<span class="token punctuation">,</span> <span class="token comment">// 全局变量名称，设置format: iife才有效，打包结果为 var 全局变量名称 = (() =&gt; {return xxx})()</span>
  <span class="token literal-property property">platform</span><span class="token operator">:</span> format <span class="token operator">===</span> <span class="token string">&#39;cjs&#39;</span> <span class="token operator">?</span> <span class="token string">&#39;node&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;browser&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 打包结果运行环境</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token comment">// 插件，如果项目配置了enableNonBrowserBranches表示需要再飞浏览器的环境下运行</span>
    format <span class="token operator">===</span> <span class="token string">&#39;cjs&#39;</span> <span class="token operator">||</span> pkg<span class="token punctuation">.</span>buildOptions<span class="token operator">?.</span>enableNonBrowserBranches
      <span class="token operator">?</span> <span class="token punctuation">[</span>nodePolyfills<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment">// 导入node内置模块</span>
      <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  <span class="token literal-property property">define</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 自定义一些全局变量</span>
    <span class="token literal-property property">__COMMIT__</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&quot;dev&quot;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token comment">// 打包环境</span>
    <span class="token literal-property property">__VERSION__</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>pkg<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token comment">// 项目版本</span>
    <span class="token literal-property property">__DEV__</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">true</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token comment">// 是否为开发环境</span>
    <span class="token literal-property property">__TEST__</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">false</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token comment">// 是否为测试环境</span>
    <span class="token literal-property property">__BROWSER__</span><span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>
      format <span class="token operator">!==</span> <span class="token string">&#39;cjs&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>pkg<span class="token punctuation">.</span>buildOptions<span class="token operator">?.</span>enableNonBrowserBranches
    <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 是否为浏览器环境</span>
    <span class="token literal-property property">__GLOBAL__</span><span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>format <span class="token operator">===</span> <span class="token string">&#39;global&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 是否是global版本的包</span>
    <span class="token literal-property property">__ESM_BUNDLER__</span><span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>format<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;esm-bundler&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 是否是esm-bundle版本的包</span>
    <span class="token literal-property property">__ESM_BROWSER__</span><span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>format<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;esm-browser&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 是否是esm-browser版本的包</span>
    <span class="token literal-property property">__NODE_JS__</span><span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>format <span class="token operator">===</span> <span class="token string">&#39;cjs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 是否是node环境</span>
    <span class="token literal-property property">__SSR__</span><span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>format <span class="token operator">===</span> <span class="token string">&#39;cjs&#39;</span> <span class="token operator">||</span> format<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;esm-bundler&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 是否可以进行服务器渲染</span>
    <span class="token literal-property property">__COMPAT__</span><span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>target <span class="token operator">===</span> <span class="token string">&#39;vue-compat&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 是否是兼容模式</span>
    <span class="token literal-property property">__FEATURE_SUSPENSE__</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">true</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token comment">// 能否使用suspense组件</span>
    <span class="token literal-property property">__FEATURE_OPTIONS_API__</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">true</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token comment">// 能否使用options API</span>
    <span class="token literal-property property">__FEATURE_PROD_DEVTOOLS__</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">false</span><span class="token template-punctuation string">\`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">watch</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 对入口文件以及依赖进行监听，如果变化就重新触发打包</span>
    <span class="token function">onRebuild</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 重新打包时打印打包后的项目路径</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">rebuilt: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>relativeOutfile<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 开启监听时的打包后项目路径</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">watching: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>relativeOutfile<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>scripts/dev.js</code> 脚本主要做了两件事，一个标准化参数，一个执行打包</p><h2 id="rollup-打包" tabindex="-1"><a class="header-anchor" href="#rollup-打包" aria-hidden="true">#</a> rollup 打包</h2><p>Vue3在打包阶段使用的是rollup，它可以输出体积更小的打包文件以及更好的tree-shaking</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;private&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3.2.45&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;packageManager&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pnpm@7.1.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node scripts/build.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>打包流程在build脚本中</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs-extra&#39;</span><span class="token punctuation">)</span> <span class="token comment">// fs模块，只不过多了一些方法</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> chalk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;chalk&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 处理在终端输出的字符串样式</span>
<span class="token keyword">const</span> execa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;execa&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 运行命令库</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> gzipSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;zlib&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 压缩库</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> compress <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;brotli&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 压缩库</span>
<span class="token comment">// allTargets：所有项目名称列表，fuzzyMatchTarget：项目名称列表匹配方法</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">targets</span><span class="token operator">:</span> allTargets<span class="token punctuation">,</span> fuzzyMatchTarget <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./utils&#39;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;minimist&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 获取命令行参数</span>

<span class="token keyword">const</span> targets <span class="token operator">=</span> args<span class="token punctuation">.</span>_ <span class="token comment">// 需要打包的项目</span>
<span class="token keyword">const</span> formats <span class="token operator">=</span> args<span class="token punctuation">.</span>formats <span class="token operator">||</span> args<span class="token punctuation">.</span>f <span class="token comment">// 打包版本</span>
<span class="token keyword">const</span> devOnly <span class="token operator">=</span> args<span class="token punctuation">.</span>devOnly <span class="token operator">||</span> args<span class="token punctuation">.</span>d <span class="token comment">// 是否为开发版本，一般测试配置</span>
<span class="token keyword">const</span> prodOnly <span class="token operator">=</span> <span class="token operator">!</span>devOnly <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>prodOnly <span class="token operator">||</span> args<span class="token punctuation">.</span>p<span class="token punctuation">)</span> <span class="token comment">// 是否为生产版本</span>
<span class="token keyword">const</span> sourceMap <span class="token operator">=</span> args<span class="token punctuation">.</span>sourcemap <span class="token operator">||</span> args<span class="token punctuation">.</span>s <span class="token comment">// 源码地图</span>
<span class="token keyword">const</span> isRelease <span class="token operator">=</span> args<span class="token punctuation">.</span>release
<span class="token keyword">const</span> buildTypes <span class="token operator">=</span> args<span class="token punctuation">.</span>t <span class="token operator">||</span> args<span class="token punctuation">.</span>types <span class="token operator">||</span> isRelease <span class="token comment">// 构建声明文件</span>
<span class="token keyword">const</span> buildAllMatching <span class="token operator">=</span> args<span class="token punctuation">.</span>all <span class="token operator">||</span> args<span class="token punctuation">.</span>a <span class="token comment">// 是否匹配全部模块，作为fuzzyMatchTarget第二个参数</span>
<span class="token keyword">const</span> commit <span class="token operator">=</span> execa<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">&#39;git&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;rev-parse&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;HEAD&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token comment">// 获取最近commit id的前七位</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 运行打包</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// 打包函数入口</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">buildAll</span><span class="token punctuation">(</span><span class="token parameter">targets</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// 构建打包队列并运行打包</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runParallel</span><span class="token punctuation">(</span><span class="token parameter">maxConcurrency<span class="token punctuation">,</span> source<span class="token punctuation">,</span> iteratorFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// 打包函数</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// 打印所有项目打包体积</span>
<span class="token keyword">function</span> <span class="token function">checkAllSizes</span><span class="token punctuation">(</span><span class="token parameter">targets</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// 打印单项目体积</span>
<span class="token keyword">function</span> <span class="token function">checkSize</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// 打印文件体积</span>
<span class="token keyword">function</span> <span class="token function">checkFileSize</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在执行打包流程前导入一些需要用到的库、工具函数、打包参数，打包参数是根据命令行参数获得，之后正式进入打包流程，首先执行了函数 <code>run</code></p><h3 id="打包流程" tabindex="-1"><a class="header-anchor" href="#打包流程" aria-hidden="true">#</a> 打包流程</h3><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isRelease<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 删除缓存</span>
    <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;../node_modules/.rts2_cache&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>targets<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果targets没有值则打包全部项目</span>
    <span class="token keyword">await</span> <span class="token function">buildAll</span><span class="token punctuation">(</span>allTargets<span class="token punctuation">)</span>
    <span class="token comment">// 打印打包后文件体积</span>
    <span class="token function">checkAllSizes</span><span class="token punctuation">(</span>allTargets<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果targets有值则打包部分项目</span>
    <span class="token keyword">await</span> <span class="token function">buildAll</span><span class="token punctuation">(</span><span class="token function">fuzzyMatchTarget</span><span class="token punctuation">(</span>targets<span class="token punctuation">,</span> buildAllMatching<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">checkAllSizes</span><span class="token punctuation">(</span><span class="token function">fuzzyMatchTarget</span><span class="token punctuation">(</span>targets<span class="token punctuation">,</span> buildAllMatching<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>run</code> 函数是打包流程入口</p><ul><li>根据需要打包项目参数（targets）处理打包情况，如果没有传需要打包的项目则认为打包所有项目</li><li>调用 <code>buildAll</code> 函数进行对应项目打包</li><li>调用 <code>checkAllSizes</code> 函数打印打包后文件体积</li></ul><p>接下来进入正式的打包流程，函数 <code>buildAll</code> 为入口函数</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 打包函数入口</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">buildAll</span><span class="token punctuation">(</span><span class="token parameter">targets</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 传入cpu核数，模块列表，打包函数</span>
  <span class="token keyword">await</span> <span class="token function">runParallel</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;os&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> build<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 构建打包队列并运行打包</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runParallel</span><span class="token punctuation">(</span><span class="token parameter">maxConcurrency<span class="token punctuation">,</span> source<span class="token punctuation">,</span> iteratorFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ret <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> executing <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 执行队列</span>
  <span class="token comment">// 遍历项目列表source构建打包异步队列ret</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> item <span class="token keyword">of</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 利用promise构建异步函数，函数内触发打包函数iteratorFn，传入项目名称，项目列表</span>
    <span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">iteratorFn</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">)</span>
    ret<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>

    <span class="token comment">// 打包的任务大于cpu核数则需要执行队列</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>maxConcurrency <span class="token operator">&lt;=</span> source<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将打包函数存入队列，如果执行完毕则删除该项</span>
      <span class="token keyword">const</span> e <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> executing<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>executing<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      executing<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>executing<span class="token punctuation">.</span>length <span class="token operator">&gt;=</span> maxConcurrency<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果执行队列等于cpu核数，则等待队列中任何一个打包任务执行完毕</span>
        <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span>executing<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>函数 <code>buildAll</code> 获取当前cpu核数，实际通过 <code>runParallel</code> 函数打包。<code>runParallel</code> 函数逻辑也比较清晰，充分利用cpu核数进行打包，如果打包项目数量小于cpu核数则直接构建队列打包，否则需要控制队列任务，当某任务执行完毕在插入新任务，直到所有打包任务完成</p><p>其中打包函数就是 <code>iteratorFn</code> 也就是传入的 <code>build</code> 函数</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> formats <span class="token operator">=</span> args<span class="token punctuation">.</span>formats <span class="token operator">||</span> args<span class="token punctuation">.</span>f <span class="token comment">// 打包版本</span>
<span class="token keyword">const</span> buildTypes <span class="token operator">=</span> args<span class="token punctuation">.</span>t <span class="token operator">||</span> args<span class="token punctuation">.</span>types <span class="token operator">||</span> isRelease <span class="token comment">// 构建声明文件</span>
<span class="token keyword">const</span> devOnly <span class="token operator">=</span> args<span class="token punctuation">.</span>devOnly <span class="token operator">||</span> args<span class="token punctuation">.</span>d <span class="token comment">// 只打包开发版本，一般测试配置</span>
<span class="token keyword">const</span> prodOnly <span class="token operator">=</span> <span class="token operator">!</span>devOnly <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>prodOnly <span class="token operator">||</span> args<span class="token punctuation">.</span>p<span class="token punctuation">)</span> <span class="token comment">// 是否为生产版本</span>
<span class="token keyword">const</span> sourceMap <span class="token operator">=</span> args<span class="token punctuation">.</span>sourcemap <span class="token operator">||</span> args<span class="token punctuation">.</span>s <span class="token comment">// 源码地图</span>
<span class="token keyword">const</span> commit <span class="token operator">=</span> execa<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">&#39;git&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;rev-parse&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;HEAD&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token comment">// 获取最近commit id的前七位</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> pkgDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">packages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span> <span class="token comment">// 项目路径</span>
  <span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>pkgDir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/package.json</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span> <span class="token comment">// 项目配置文件</span>

  <span class="token comment">// 私有项目不参与打包</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>isRelease <span class="token operator">||</span> <span class="token operator">!</span>targets<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>private<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 没有指定构建格式则删除dist目录</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>formats<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>pkgDir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/dist</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// NODE_ENV变量</span>
  <span class="token keyword">const</span> env <span class="token operator">=</span>
    <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>buildOptions <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>buildOptions<span class="token punctuation">.</span>env<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token punctuation">(</span>devOnly <span class="token operator">?</span> <span class="token string">&#39;development&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;production&#39;</span><span class="token punctuation">)</span>

  <span class="token comment">// 执行rollup -c --environment &quot;COMMIT:true, ...&quot;命令</span>
  <span class="token keyword">await</span> <span class="token function">execa</span><span class="token punctuation">(</span>
    <span class="token string">&#39;rollup&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
      <span class="token string">&#39;-c&#39;</span><span class="token punctuation">,</span>
      <span class="token string">&#39;--environment&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>
        <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">COMMIT:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>commit<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">NODE_ENV:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">TARGET:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
        formats <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">FORMATS:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>formats<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
        buildTypes <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">TYPES:true</span><span class="token template-punctuation string">\`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
        prodOnly <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">PROD_ONLY:true</span><span class="token template-punctuation string">\`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
        sourceMap <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">SOURCE_MAP:true</span><span class="token template-punctuation string">\`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token template-punctuation string">\`</span></span>
      <span class="token punctuation">]</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;,&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">stdio</span><span class="token operator">:</span> <span class="token string">&#39;inherit&#39;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>buildTypes <span class="token operator">&amp;&amp;</span> pkg<span class="token punctuation">.</span>types<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果配置输出声明文件且项目配置输出声明文件路径</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
      chalk<span class="token punctuation">.</span><span class="token function">bold</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">Rolling up type definitions for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">...</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token comment">// 使用@microsoft/api-extractor库来输出声明文件</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> Extractor<span class="token punctuation">,</span> ExtractorConfig <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@microsoft/api-extractor&#39;</span><span class="token punctuation">)</span>
    <span class="token comment">// 获取api-extractor配置</span>
    <span class="token keyword">const</span> extractorConfigPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>pkgDir<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">api-extractor.json</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
    <span class="token comment">// 将配置文件转化成配置实例</span>
    <span class="token keyword">const</span> extractorConfig <span class="token operator">=</span>
      ExtractorConfig<span class="token punctuation">.</span><span class="token function">loadFileAndPrepare</span><span class="token punctuation">(</span>extractorConfigPath<span class="token punctuation">)</span>
    <span class="token comment">// 传入配置生成声明文件</span>
    <span class="token keyword">const</span> extractorResult <span class="token operator">=</span> Extractor<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>extractorConfig<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">localBuild</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">showVerboseMessages</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>extractorResult<span class="token punctuation">.</span>succeeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 成功输出声明文件</span>
      <span class="token comment">// 处理项目目录下的types目录下文件</span>
      <span class="token keyword">const</span> typesDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>pkgDir<span class="token punctuation">,</span> <span class="token string">&#39;types&#39;</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>typesDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将types目录下每个.d.ts文件读出来写入项目配置中的types路径，一般为dist/项目.d.ts</span>
        <span class="token keyword">const</span> dtsPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>pkgDir<span class="token punctuation">,</span> pkg<span class="token punctuation">.</span>types<span class="token punctuation">)</span>
        <span class="token keyword">const</span> existing <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>dtsPath<span class="token punctuation">,</span> <span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> typeFiles <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>typesDir<span class="token punctuation">)</span>
        <span class="token keyword">const</span> toAdd <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
          typeFiles<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>typesDir<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>dtsPath<span class="token punctuation">,</span> existing <span class="token operator">+</span> <span class="token string">&#39;\\n&#39;</span> <span class="token operator">+</span> toAdd<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;\\n&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        chalk<span class="token punctuation">.</span><span class="token function">bold</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">API Extractor completed successfully.</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果声明文件输出失败程序退出</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">API Extractor completed with </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>extractorResult<span class="token punctuation">.</span>errorCount<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> errors</span><span class="token template-punctuation string">\`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"> and </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>extractorResult<span class="token punctuation">.</span>warningCount<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> warnings</span><span class="token template-punctuation string">\`</span></span>
      <span class="token punctuation">)</span>
      process<span class="token punctuation">.</span>exitCode <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>pkgDir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/dist/packages</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>build</code> 首先执行 <code>rollup</code> 命令并传入对应参数进行打包，后根据 <code>buildTypes &amp;&amp; pkg.types</code> 判断是否需要生成声明文件，通过 <code>@microsoft/api-extractor</code> 库生成声明文件，文件名称根据每个项目根目录下的 <code>api-extractor.json</code> 文件配置，一般为 <code>dist/项目名称.d.ts</code>，之后再将项目跟目录下的 <code>types</code> 目录中的文件合并到输出的声明文件中</p><p>我们回到最开始的 <code>run</code> 函数，在打包结束后会输出各个项目打包后文件的体积，以及通过 <code>zlib</code> 和 <code>brotli</code> 压缩后文件的体积</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 打印所有项目打包体积</span>
<span class="token keyword">function</span> <span class="token function">checkAllSizes</span><span class="token punctuation">(</span><span class="token parameter">targets</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>devOnly <span class="token operator">||</span> <span class="token punctuation">(</span>formats <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>formats<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;global&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是开发版本或者不是全局包</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> target <span class="token keyword">of</span> targets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkSize</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 打印单项目体积</span>
<span class="token keyword">function</span> <span class="token function">checkSize</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> pkgDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">packages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
  <span class="token function">checkFileSize</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>pkgDir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/dist/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.global.prod.js</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>formats <span class="token operator">||</span> formats<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;global-runtime&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是global-runtime包则需要额外打印体积</span>
    <span class="token function">checkFileSize</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>pkgDir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/dist/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.runtime.global.prod.js</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 输出打爆体积</span>
<span class="token keyword">function</span> <span class="token function">checkFileSize</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> file <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
  <span class="token keyword">const</span> minSize <span class="token operator">=</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;kb&#39;</span>
  <span class="token keyword">const</span> gzipped <span class="token operator">=</span> <span class="token function">gzipSync</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
  <span class="token keyword">const</span> gzippedSize <span class="token operator">=</span> <span class="token punctuation">(</span>gzipped<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;kb&#39;</span>
  <span class="token keyword">const</span> compressed <span class="token operator">=</span> <span class="token function">compress</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
  <span class="token keyword">const</span> compressedSize <span class="token operator">=</span> <span class="token punctuation">(</span>compressed<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;kb&#39;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>chalk<span class="token punctuation">.</span><span class="token function">gray</span><span class="token punctuation">(</span>
      chalk<span class="token punctuation">.</span><span class="token function">bold</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> min:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>minSize<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> / gzip:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>gzippedSize<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> / brotli:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>compressedSize<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>到这里整个打包流程就结束了，总结下就是充分利用cpu的核数进行打包，打包工具是使用rollup打包，之后通过@microsoft/api-extractor库进行输出项目总声明文件，接着将项目根目录下types目录的声明文件合并到项目总声明文件内</p><h3 id="rollup-配置" tabindex="-1"><a class="header-anchor" href="#rollup-配置" aria-hidden="true">#</a> rollup 配置</h3><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">execa</span><span class="token punctuation">(</span>
    <span class="token string">&#39;rollup&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
      <span class="token string">&#39;-c&#39;</span><span class="token punctuation">,</span>
      <span class="token string">&#39;--environment&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>
        <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">COMMIT:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>commit<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">NODE_ENV:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">TARGET:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
        formats <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">FORMATS:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>formats<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
        buildTypes <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">TYPES:true</span><span class="token template-punctuation string">\`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
        prodOnly <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">PROD_ONLY:true</span><span class="token template-punctuation string">\`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
        sourceMap <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">SOURCE_MAP:true</span><span class="token template-punctuation string">\`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token template-punctuation string">\`</span></span>
      <span class="token punctuation">]</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;,&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">stdio</span><span class="token operator">:</span> <span class="token string">&#39;inherit&#39;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <code>build</code> 函数中是调用 <code>rollup</code> 命令进行打包，并传入一些参数，rollup 打包默认会读取项目根目录的 <code>rollup.config.mjs</code> 文件导出结果作为配置，<code>rollup.config.mjs</code> 文件主要做了两件事，我们分别研究</p><ol><li>确定打包格式 <code>packageFormats</code></li><li>构建打包配置 <code>packageConfigs</code></li></ol><h4 id="确定打包格式-packageformats" tabindex="-1"><a class="header-anchor" href="#确定打包格式-packageformats" aria-hidden="true">#</a> 确定打包格式 <code>packageFormats</code></h4><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createRequire <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;module&#39;</span> <span class="token comment">// node内置模块，这里导入一个创建require的函数</span>

<span class="token keyword">const</span> require <span class="token operator">=</span> <span class="token function">createRequire</span><span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token comment">// 创建一个require函数</span>

<span class="token keyword">const</span> packagesDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;packages&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 获取项目目录路径</span>
<span class="token keyword">const</span> packageDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>packagesDir<span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TARGET</span><span class="token punctuation">)</span> <span class="token comment">// 打包项目路径</span>

<span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">p</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>packageDir<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment">// 获取路径方法，基于打包项目路径</span>
<span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">package.json</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 打包项目的package.json</span>
<span class="token keyword">const</span> packageOptions <span class="token operator">=</span> pkg<span class="token punctuation">.</span>buildOptions <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 打包项目的打包配置</span>

<span class="token comment">// 根据优先级标准化打包版本 命令行参数 &gt; 项目配置 &gt; 默认打包版本</span>
<span class="token keyword">const</span> defaultFormats <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;esm-bundler&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;cjs&#39;</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> inlineFormats <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">FORMATS</span> <span class="token operator">&amp;&amp;</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">FORMATS</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;,&#39;</span><span class="token punctuation">)</span> <span class="token comment">// 命令行-f参数传入的打包版本</span>
<span class="token keyword">const</span> packageFormats <span class="token operator">=</span> inlineFormats <span class="token operator">||</span> packageOptions<span class="token punctuation">.</span>formats <span class="token operator">||</span> defaultFormats
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>构建打包格式 <code>packageFormats</code> 优先考虑命令行 <code>-formats</code> 参数传入的打包格式，其次考虑项目配置文件 <code>package.json</code> 中的 <code>buildOptions.formats</code> 配置，最后考虑默认的打包版本。所以优先级为：命令行参数 &gt; 项目配置 &gt; 默认打包版本</p><p>为了获取打包项目的配置文件 <code>package.json</code> 需要做一些准备工作，首先创建 <code>require</code> 函数用来导入文件，下一步获取项目目录路径 <code>packagesDir</code> 和打包项目路径 <code>packageDir</code> ，接着对 <code>path.resolve</code> 函数进行封装，这样不用每次都传入打包项目路径，最后直接通过 <code>require(resolve(<code>package.json</code>))</code> 获取打包项目的 <code>package.json</code> 文件内容并获取打包配置 <code>packageOptions</code></p><h4 id="构建打包配置-packageconfigs" tabindex="-1"><a class="header-anchor" href="#构建打包配置-packageconfigs" aria-hidden="true">#</a> 构建打包配置 <code>packageConfigs</code></h4><p>构建打包配置需要依赖打包格式 <code>packageFormats</code>，将每一种打包格式都创建一个配置通过 <code>packageConfigs</code> 保存并导出作为 <code>rollup</code> 的打包配置</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 输出配置表</span>
<span class="token keyword">const</span> outputConfigs <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">&#39;esm-bundler&#39;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 构建工具中使用原声模块导入</span>
    file<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">dist/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.esm-bundler.js</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">es</span><span class="token template-punctuation string">\`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">&#39;esm-browser&#39;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 浏览器原生ES模块导入</span>
    file<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">dist/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.esm-browser.js</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">es</span><span class="token template-punctuation string">\`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  cjs<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// commonJS模块</span>
    file<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">dist/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.cjs.js</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">cjs</span><span class="token template-punctuation string">\`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  global<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 全局变量版本</span>
    file<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">dist/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.global.js</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">iife</span><span class="token template-punctuation string">\`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// -runtime为运行时包，不带编译器版本</span>
  <span class="token string-property property">&#39;esm-bundler-runtime&#39;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    file<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">dist/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.runtime.esm-bundler.js</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">es</span><span class="token template-punctuation string">\`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">&#39;esm-browser-runtime&#39;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    file<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">dist/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.runtime.esm-browser.js</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">&#39;es&#39;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">&#39;global-runtime&#39;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    file<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">dist/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.runtime.global.js</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    format<span class="token operator">:</span> <span class="token string">&#39;iife&#39;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> packageConfigs <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PROD_ONLY</span> <span class="token comment">// 是否只打包生产版本</span>
  <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token operator">:</span> packageFormats<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>format <span class="token operator">=&gt;</span> <span class="token function">createConfig</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> outputConfigs<span class="token punctuation">[</span>format<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;production&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 生产环境打包逻辑</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> packageConfigs
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,67),k=s("code",null,[n("p"),s("wbr"),n("rocess.env.PROD_ONLY")],-1),d=s("code",null,"-devOnly",-1),m=s("code",null,"-prodOnly",-1),v={href:"/vue3%E6%BA%90%E7%A0%81/100.%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA.html#%E6%89%93%E5%8C%85%E6%B5%81%E7%A8%8B",target:"_blank",rel:"noopener noreferrer"},b=s("code",null,[n("p"),s("wbr"),n("rocess.env.PROD_ONLY")],-1),g=a(`<p><code>packageConfigs</code> 是通过遍历 <code>packageFormats</code> 调用 <code>createConfig</code> 函数构建，调用 <code>createConfig</code> 函数传入每个打包格式以及对应的输出配置</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 构建打包配置</span>
<span class="token keyword">function</span> <span class="token function">createConfig</span><span class="token punctuation">(</span>
  format<span class="token punctuation">,</span> <span class="token comment">// 打包格式</span>
  output<span class="token punctuation">,</span> <span class="token comment">// 打包输出配置</span>
  plugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 打包使用的插件</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 构建各个配置</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">input</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>entryFile<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 入口文件配置</span>
    external<span class="token punctuation">,</span> <span class="token comment">// 不需要打包配置</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">namedExports</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// json文件转化为ES模块插件</span>
      tsPlugin<span class="token punctuation">,</span> <span class="token comment">// 转化ts代码为js插件</span>
      <span class="token function">createReplacePlugin</span><span class="token punctuation">(</span> <span class="token comment">// 替换项目内环境变量插件</span>
        isProductionBuild<span class="token punctuation">,</span>
        isBundlerESMBuild<span class="token punctuation">,</span>
        isBrowserESMBuild<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>isGlobalBuild <span class="token operator">||</span> isBrowserESMBuild <span class="token operator">||</span> isBundlerESMBuild<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          <span class="token operator">!</span>packageOptions<span class="token punctuation">.</span>enableNonBrowserBranches<span class="token punctuation">,</span>
        isGlobalBuild<span class="token punctuation">,</span>
        isNodeBuild<span class="token punctuation">,</span>
        isCompatBuild<span class="token punctuation">,</span>
        isServerRenderer
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token operator">...</span>nodePlugins<span class="token punctuation">,</span> <span class="token comment">// commonjs转化es模块插件</span>
      <span class="token operator">...</span>plugins <span class="token comment">// 参数插件</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    output<span class="token punctuation">,</span> <span class="token comment">// 出口配置</span>
    <span class="token function-variable function">onwarn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> warn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 处理报错信息</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">Circular</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 报错信息中排除Circular报错</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">treeshake</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">moduleSideEffects</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token comment">// 删除导入未使用的模块引用语句</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>createConfig</code> 函数返回打包配置，内容很多我们围绕返回配置进行拆解，先看 <code>input</code>、<code>external</code>、<code>output</code> 配置的逻辑</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// 构建打包配置</span>
<span class="token keyword">function</span> <span class="token function">createConfig</span><span class="token punctuation">(</span>
  format<span class="token punctuation">,</span> <span class="token comment">// 打包格式</span>
  output<span class="token punctuation">,</span> <span class="token comment">// 打包输出配置</span>
  plugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 打包使用的插件</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isCompatPackage <span class="token operator">=</span> pkg<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#39;@vue/compat&#39;</span> <span class="token comment">// 是否是兼容项目</span>
  <span class="token keyword">const</span> isBrowserESMBuild <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">esm-browser</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span> <span class="token comment">// 是否为浏览器版本</span>
  <span class="token keyword">const</span> isBundlerESMBuild <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">esm-bundler</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span> <span class="token comment">// 是否为构建工具版本</span>
  <span class="token keyword">const</span> isGlobalBuild <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">global</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span> <span class="token comment">// 是否为全局变量版本</span>

  <span class="token comment">// 入口文件配置</span>
  <span class="token keyword">let</span> entryFile <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">runtime$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">src/runtime.ts</span><span class="token template-punctuation string">\`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">src/index.ts</span><span class="token template-punctuation string">\`</span></span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isCompatPackage <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>isBrowserESMBuild <span class="token operator">||</span> isBundlerESMBuild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是兼容版本，也就是vue-compat仓库，需要更换打包入口</span>
    entryFile <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">runtime$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span>
      <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">src/esm-runtime.ts</span><span class="token template-punctuation string">\`</span></span>
      <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">src/esm-index.ts</span><span class="token template-punctuation string">\`</span></span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> external <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 不参与打包配置</span>
  <span class="token keyword">const</span> treeShakenDeps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;source-map&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;@babel/parser&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;estree-walker&#39;</span><span class="token punctuation">]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isGlobalBuild <span class="token operator">||</span> isBrowserESMBuild <span class="token operator">||</span> isCompatPackage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 全局版本。浏览器版本、兼容版本，如果没有配置enableNonBrowserBranches则所有依赖都参与打包</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>packageOptions<span class="token punctuation">.</span>enableNonBrowserBranches<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      external <span class="token operator">=</span> treeShakenDeps
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    external <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token operator">...</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>dependencies <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 生产环境依赖</span>
      <span class="token operator">...</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>peerDependencies <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 依赖描述，peerDependencies 指的是设定依赖兼容最小版本</span>
      <span class="token operator">...</span><span class="token punctuation">[</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;url&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;stream&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 服务端依赖</span>
      <span class="token operator">...</span>treeShakenDeps
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  output<span class="token punctuation">.</span>exports <span class="token operator">=</span> isCompatPackage <span class="token operator">?</span> <span class="token string">&#39;auto&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;named&#39;</span> <span class="token comment">// 设置导出模式，named为导出多个模块，auto为自动选择导出模式</span>
  output<span class="token punctuation">.</span>sourcemap <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SOURCE_MAP</span> <span class="token comment">// 设置源码地图</span>
  output<span class="token punctuation">.</span>externalLiveBindings <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 不会为外部依赖生成支持动态绑定的代码，而是假定外部依赖永远不会改变，当外部依赖存在循环引用时，该选项值为 false 可能会引起问题</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isGlobalBuild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是全局变量版本需要设置全局变量名称</span>
    output<span class="token punctuation">.</span>name <span class="token operator">=</span> packageOptions<span class="token punctuation">.</span>name
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    input<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>entryFile<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 入口文件配置</span>
    external<span class="token punctuation">,</span> <span class="token comment">// 不需要打包配置</span>
    output<span class="token punctuation">,</span> <span class="token comment">// 出口配置</span>

    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>入口文件 <code>entryFile</code> 是根据打包格式 <code>format</code> 进行判断，首先根据打包格式中是否含有 runtime 字符串判断是否是运行时版本，如果是兼容版本并且在浏览器环境中运行则需要额外逻辑</p><p><code>external</code> 会根据打包版本做区分，部分项目的打包需要排除一些库，其中全局版本、浏览器版本、兼容版本的依赖都将参与打包</p><p>输出配置 <code>output</code> 本来是外部传入的参数，内部根据打包格式对输出配置进行拓展</p><p>之后看 <code>plugins</code> 配置</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> ts <span class="token keyword">from</span> <span class="token string">&#39;rollup-plugin-typescript2&#39;</span> <span class="token comment">// ts插件，转化ts代码为js</span>
<span class="token keyword">import</span> replace <span class="token keyword">from</span> <span class="token string">&#39;@rollup/plugin-replace&#39;</span> <span class="token comment">// 替换文件内字符串插件</span>
<span class="token keyword">import</span> json <span class="token keyword">from</span> <span class="token string">&#39;@rollup/plugin-json&#39;</span> <span class="token comment">// 将json文件转化为ES模块</span>
<span class="token keyword">import</span> commonJS <span class="token keyword">from</span> <span class="token string">&#39;@rollup/plugin-commonjs&#39;</span> <span class="token comment">// 将commonJS模块转化为ES模块插件，因为rollup仅支持ES模块</span>
<span class="token keyword">import</span> polyfillNode <span class="token keyword">from</span> <span class="token string">&#39;rollup-plugin-polyfill-node&#39;</span> <span class="token comment">// 如果想在浏览器环境使用一些node模块，则需要该插件</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> nodeResolve <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@rollup/plugin-node-resolve&#39;</span> <span class="token comment">// 使用算法快速定位node_modules中的模块</span>

<span class="token comment">// 构建打包配置</span>
<span class="token keyword">function</span> <span class="token function">createConfig</span><span class="token punctuation">(</span>
  format<span class="token punctuation">,</span> <span class="token comment">// 打包格式</span>
  output<span class="token punctuation">,</span> <span class="token comment">// 打包输出配置</span>
  plugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 打包使用的插件</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ts插件配置</span>
  <span class="token keyword">const</span> tsPlugin <span class="token operator">=</span> <span class="token function">ts</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">check</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;production&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hasTSChecked<span class="token punctuation">,</span> <span class="token comment">// 生产环境需要进行ts检查</span>
    <span class="token literal-property property">tsconfig</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;tsconfig.json&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// ts配置文件路径</span>
    <span class="token literal-property property">cacheRoot</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;node_modules/.rts2_cache&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 缓存路径</span>
    <span class="token literal-property property">tsconfigOverride</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 替换ts配置文件配置</span>
      <span class="token literal-property property">compilerOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">target</span><span class="token operator">:</span> isServerRenderer <span class="token operator">||</span> isNodeBuild <span class="token operator">?</span> <span class="token string">&#39;es2019&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;es2015&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 如果是服务器渲染或cjs版本则使用es2019标准，否则es2015标准</span>
        <span class="token literal-property property">sourceMap</span><span class="token operator">:</span> output<span class="token punctuation">.</span>sourcemap<span class="token punctuation">,</span> <span class="token comment">// 源码地图</span>
        <span class="token literal-property property">declaration</span><span class="token operator">:</span> shouldEmitDeclarations<span class="token punctuation">,</span> <span class="token comment">// ts声明文件</span>
        <span class="token literal-property property">declarationMap</span><span class="token operator">:</span> shouldEmitDeclarations
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;**/__tests__&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;test-dts&#39;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// cjs版本需要将commonjs模块转化为ES模块，因此需要配置额外的插件</span>
  <span class="token keyword">const</span> nodePlugins <span class="token operator">=</span>
    <span class="token punctuation">(</span>format <span class="token operator">===</span> <span class="token string">&#39;cjs&#39;</span><span class="token punctuation">)</span> <span class="token operator">||</span> packageOptions<span class="token punctuation">.</span>enableNonBrowserBranches
      <span class="token operator">?</span> <span class="token punctuation">[</span>
          <span class="token function">commonJS</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">sourceMap</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token literal-property property">ignore</span><span class="token operator">:</span> cjsIgnores
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token operator">...</span><span class="token punctuation">(</span>format <span class="token operator">===</span> <span class="token string">&#39;cjs&#39;</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">polyfillNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// polyfillNode是在浏览器中使用node插件</span>
          <span class="token function">nodeResolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
      <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">namedExports</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// json文件转化为ES模块插件</span>
      tsPlugin<span class="token punctuation">,</span> <span class="token comment">// 转化ts代码为js插件</span>
      <span class="token function">createReplacePlugin</span><span class="token punctuation">(</span> <span class="token comment">// 替换项目内环境变量插件</span>
        isProductionBuild<span class="token punctuation">,</span>
        isBundlerESMBuild<span class="token punctuation">,</span>
        isBrowserESMBuild<span class="token punctuation">,</span>
        <span class="token comment">// isBrowserBuild?</span>
        <span class="token punctuation">(</span>isGlobalBuild <span class="token operator">||</span> isBrowserESMBuild <span class="token operator">||</span> isBundlerESMBuild<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          <span class="token operator">!</span>packageOptions<span class="token punctuation">.</span>enableNonBrowserBranches<span class="token punctuation">,</span>
        isGlobalBuild<span class="token punctuation">,</span>
        isNodeBuild<span class="token punctuation">,</span>
        isCompatBuild<span class="token punctuation">,</span>
        isServerRenderer
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token operator">...</span>nodePlugins<span class="token punctuation">,</span> <span class="token comment">// commonjs转化es模块插件</span>
      <span class="token operator">...</span>plugins <span class="token comment">// 参数插件</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

<span class="token comment">// 创建替换环境变量插件</span>
<span class="token keyword">function</span> <span class="token function">createReplacePlugin</span><span class="token punctuation">(</span>
  isProduction<span class="token punctuation">,</span> <span class="token comment">// 生产版本</span>
  isBundlerESMBuild<span class="token punctuation">,</span> <span class="token comment">// 构建工具版本</span>
  isBrowserESMBuild<span class="token punctuation">,</span> <span class="token comment">// 浏览器版本</span>
  isBrowserBuild<span class="token punctuation">,</span> <span class="token comment">// 浏览器版本，这里指isGlobalBuild、isBrowserESMBuild、isBundlerESMBuild任意一个版本</span>
  isGlobalBuild<span class="token punctuation">,</span> <span class="token comment">// 全局版本</span>
  isNodeBuild<span class="token punctuation">,</span> <span class="token comment">// cjs版本</span>
  isCompatBuild<span class="token punctuation">,</span> <span class="token comment">// 兼容版本</span>
  isServerRenderer <span class="token comment">// 服务器版本</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 构建环境变量</span>
  <span class="token keyword">const</span> replacements <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">__COMMIT__</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COMMIT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token comment">// 当前版本库最新commit id</span>
    <span class="token literal-property property">__VERSION__</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>masterVersion<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token comment">// 主项目版本</span>
    <span class="token literal-property property">__DEV__</span><span class="token operator">:</span> isBundlerESMBuild <span class="token comment">// 是开发环境</span>
      <span class="token operator">?</span> <span class="token comment">// preserve to be handled by bundlers</span>
        <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">(p<wbr>rocess.env.NODE_ENV !== &#39;production&#39;)</span><span class="token template-punctuation string">\`</span></span>
      <span class="token operator">:</span> <span class="token comment">// hard coded dev/prod builds</span>
        <span class="token operator">!</span>isProduction<span class="token punctuation">,</span>
    <span class="token literal-property property">__TEST__</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 是测试环境</span>
    <span class="token literal-property property">__BROWSER__</span><span class="token operator">:</span> isBrowserBuild<span class="token punctuation">,</span> <span class="token comment">// 是浏览器环境</span>
    <span class="token literal-property property">__GLOBAL__</span><span class="token operator">:</span> isGlobalBuild<span class="token punctuation">,</span> <span class="token comment">// 是全局环境</span>
    <span class="token literal-property property">__ESM_BUNDLER__</span><span class="token operator">:</span> isBundlerESMBuild<span class="token punctuation">,</span> <span class="token comment">// 是构建工具版本</span>
    <span class="token literal-property property">__ESM_BROWSER__</span><span class="token operator">:</span> isBrowserESMBuild<span class="token punctuation">,</span> <span class="token comment">// 是浏览器版本</span>
    <span class="token literal-property property">__NODE_JS__</span><span class="token operator">:</span> isNodeBuild<span class="token punctuation">,</span> <span class="token comment">// 是cjs版本</span>
    <span class="token literal-property property">__SSR__</span><span class="token operator">:</span> isNodeBuild <span class="token operator">||</span> isBundlerESMBuild <span class="token operator">||</span> isServerRenderer<span class="token punctuation">,</span> <span class="token comment">// 是服务器渲染</span>

    <span class="token comment">// for compiler-sfc browser build inlined deps</span>
    <span class="token operator">...</span><span class="token punctuation">(</span>isBrowserESMBuild
      <span class="token operator">?</span> <span class="token punctuation">{</span>
          <span class="token string-property property">&#39;p<wbr>rocess.env&#39;</span><span class="token operator">:</span> <span class="token string">&#39;({})&#39;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&#39;process.platform&#39;</span><span class="token operator">:</span> <span class="token string">&#39;&quot;&quot;&#39;</span><span class="token punctuation">,</span>
          <span class="token string-property property">&#39;process.stdout&#39;</span><span class="token operator">:</span> <span class="token string">&#39;null&#39;</span>
        <span class="token punctuation">}</span>
      <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">// 2.x compat build</span>
    <span class="token literal-property property">__COMPAT__</span><span class="token operator">:</span> isCompatBuild<span class="token punctuation">,</span> <span class="token comment">// 是兼容版本</span>

    <span class="token comment">// feature flags</span>
    <span class="token literal-property property">__FEATURE_SUSPENSE__</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// SUSPENSE组件</span>
    <span class="token literal-property property">__FEATURE_OPTIONS_API__</span><span class="token operator">:</span> isBundlerESMBuild <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">_<wbr>_VUE_OPTIONS_API__</span><span class="token template-punctuation string">\`</span></span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">__FEATURE_PROD_DEVTOOLS__</span><span class="token operator">:</span> isBundlerESMBuild
      <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">_<wbr>_VUE_PROD_DEVTOOLS__</span><span class="token template-punctuation string">\`</span></span>
      <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token punctuation">(</span>isProduction <span class="token operator">&amp;&amp;</span> isBrowserBuild
      <span class="token operator">?</span> <span class="token punctuation">{</span>
          <span class="token string-property property">&#39;context.onError(&#39;</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">/*#__PURE__*/ context.onError(</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
          <span class="token string-property property">&#39;emitError(&#39;</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">/*#__PURE__*/ emitError(</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
          <span class="token string-property property">&#39;createCompilerError(&#39;</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">/*#__PURE__*/ createCompilerError(</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
          <span class="token string-property property">&#39;createDOMCompilerError(&#39;</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">/*#__PURE__*/ createDOMCompilerError(</span><span class="token template-punctuation string">\`</span></span>
        <span class="token punctuation">}</span>
      <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 优先使用系统环境变量</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>replacements<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> process<span class="token punctuation">.</span>env<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      replacements<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 打包时替换replacements中对应的环境变量字符串</span>
  <span class="token keyword">return</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// @ts-ignore</span>
    <span class="token literal-property property">values</span><span class="token operator">:</span> replacements<span class="token punctuation">,</span>
    <span class="token comment">// 如果替换的变量为赋值操作则不替换，例如： __COMMIT__ = &quot;aaa&quot; </span>
    <span class="token literal-property property">preventAssignment</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>@rollup/plugin-json</code>，插件可以将 <code>json</code> 文件内容提取并转化为 ES 模块</li><li><code>rollup-plugin-typescript2</code>，插件用来转化 ts 文件，转化过程中可以进行语法检查，也可以指定 ts 配置文件</li><li><code>@rollup/plugin-replace</code>，插件用来匹配并替换代码，这里利用 <code>createReplacePlugin</code> 函数替换代码中的环境变量，例如：<strong>COMPAT</strong></li><li><code>@rollup/plugin-commonjs</code>，插件将 commonJS 模块转化成 ES 模块，因为 rollup 默认不兼容 commonJS 模块</li><li><code>rollup-plugin-polyfill-node</code>，插件可以在浏览器环境中使用部分 node 模块</li><li><code>@rollup/plugin-node-resolve</code>，插件通过一些算法可以快速的定位 node_modules 中的模块</li></ul><p>至此 <code>createConfig</code> 函数就分析完毕，该函数为输出打包配置的核心函数，通过传入的打包格式、输出配置、打包插件来构建出入口配置、插件配置、不需要打包配置。我们分析了开发环境的打包，接下来回到构建打包配置的逻辑，来分析生产环境的打包配置</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 构建打包配置</span>
<span class="token keyword">const</span> packageConfigs <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PROD_ONLY</span> <span class="token comment">// 只打包生产版本</span>
  <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token operator">:</span> packageFormats<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">format</span> <span class="token operator">=&gt;</span> <span class="token function">createConfig</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> outputConfigs<span class="token punctuation">[</span>format<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#39;production&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果是生产环境需要输出.prod.js文件</span>
  packageFormats<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">format</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>packageOptions<span class="token punctuation">.</span>prod <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>format <span class="token operator">===</span> <span class="token string">&#39;cjs&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// cjs版本打包配置</span>
      packageConfigs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">createProductionConfig</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(global|esm-browser)(-runtime)?</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// global(-runtime)、esm-browser(-runtime)版本最小体积打包配置</span>
      packageConfigs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">createMinifiedConfig</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>p<wbr>rocess.env.PROD_ONLY</code> 表示只打包生产版本，假设它为 true，那么会通过 <code>p<wbr>rocess.env.NODE_ENV === &#39;production&#39;</code> 中的逻辑来构建 <code>packageConfigs</code></p><p>通过条件语句可以看出生产环境包只有 <code>cjs</code>、<code>global(-runtime)</code>、<code>esm-browser(-runtime)</code> 五个版本，其中 <code>cjs</code> 的打包配置通过函数 <code>createProductionConfig</code> 构建，非 <code>cjs</code> 的打包配置通过函数 <code>createMinifiedConfig</code> 构建</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 构建生产环境cjs版本打包配置</span>
<span class="token keyword">function</span> <span class="token function">createProductionConfig</span><span class="token punctuation">(</span><span class="token parameter">format</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createConfig</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">file</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">dist/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>format<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.prod.js</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">format</span><span class="token operator">:</span> outputConfigs<span class="token punctuation">[</span>format<span class="token punctuation">]</span><span class="token punctuation">.</span>format
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 构建代码压缩打包配置</span>
<span class="token keyword">function</span> <span class="token function">createMinifiedConfig</span><span class="token punctuation">(</span><span class="token parameter">format</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createConfig</span><span class="token punctuation">(</span>
    format<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">file</span><span class="token operator">:</span> outputConfigs<span class="token punctuation">[</span>format<span class="token punctuation">]</span><span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&#39;.prod.js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">format</span><span class="token operator">:</span> outputConfigs<span class="token punctuation">[</span>format<span class="token punctuation">]</span><span class="token punctuation">.</span>format
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
      <span class="token function">terser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^esm</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">compress</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 压缩选项</span>
          <span class="token literal-property property">ecma</span><span class="token operator">:</span> <span class="token number">2015</span><span class="token punctuation">,</span> <span class="token comment">// 代码语法转换ES版本</span>
          <span class="token literal-property property">pure_getters</span><span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">safari10</span><span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>两个函数本质还是通过 <code>createConfig</code> 函数构建打包配置，生产环境的 <code>cjs</code> 版本和开发环境比只是将输出文件名改为 <code>dist/\${项目名称}.cjs.prod.js</code></p><p>而生产环境的 <code>global(-runtime)</code>、<code>esm-browser(-runtime)</code> 版本和开发环境比不仅将输出的文件名增加了 <code>.prod</code> 后缀，还新增了 <code>terser</code> 用于代码压缩的插件</p><h3 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h3><p>简述打包流程，首先执行 <code>/script/build.js</code> 脚本，该脚本中充分利用cpu多线程打包，之后调用 <code>rollup</code> 命令进行打包，在 <code>rollup</code> 配置中根据打包项目 <code>package.json</code> 的配置进行不同版本的打包</p><p><code>rollup</code> 打包结束后使用 <code>@microsoft/api-extractor</code> 库来生成项目的主声明文件，并将项目中 <code>/types/</code> 目录下的声明文件合并到主声明文件中，最后打印生产环境全局版本的包体积</p>`,20);function f(y,w){const t=l("ExternalLinkIcon");return e(),o("div",null,[r,s("p",null,[k,n(" 是命令行参数 "),d,n("、"),m,n(" 控制，"),s("a",v,[n("具体逻辑回顾执行打包命令时传入的 PROD_ONLY 参数"),c(t)]),n("，我们先关注生产环境打包，这里 "),b,n(" 为 false")]),g])}const x=p(u,[["render",f],["__file","100.项目构建.html.vue"]]);export{x as default};
