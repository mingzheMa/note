<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.53" />
    <meta name="theme" content="VuePress Theme Hope" />
    <title>依赖收集 | marx的学习笔记</title><meta name="description" content="部分内容是参考外部文章，属于个人复习使用">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style.31e87fe8.css" as="style" /><link rel="stylesheet" href="/assets/style.31e87fe8.css" />
    <link rel="modulepreload" href="/assets/app.9ac9284b.js"><link rel="modulepreload" href="/assets/3.依赖收集.html.ed2bf5ca.js"><link rel="modulepreload" href="/assets/_plugin-vue_export-helper.cdc0426e.js"><link rel="modulepreload" href="/assets/3.依赖收集.html.7b50dfa2.js"><link rel="prefetch" href="/assets/index.html.6c946c9f.js" as="script" /><link rel="prefetch" href="/assets/ES6和CommonJS模块化.html.993609d3.js" as="script" /><link rel="prefetch" href="/assets/index.html.c3b5ae80.js" as="script" /><link rel="prefetch" href="/assets/包装类型.html.6ad5c91c.js" as="script" /><link rel="prefetch" href="/assets/手写CommonJS.html.1498b864.js" as="script" /><link rel="prefetch" href="/assets/手写Promise.html.a9d665da.js" as="script" /><link rel="prefetch" href="/assets/生成器.html.30c11bf8.js" as="script" /><link rel="prefetch" href="/assets/类型转换.html.101bf853.js" as="script" /><link rel="prefetch" href="/assets/迭代器.html.09e1ba62.js" as="script" /><link rel="prefetch" href="/assets/0.React中的TS集成.html.72297c73.js" as="script" /><link rel="prefetch" href="/assets/0.TSConfig配置.html.8e862c7f.js" as="script" /><link rel="prefetch" href="/assets/0.infer关键字.html.2de3f009.js" as="script" /><link rel="prefetch" href="/assets/0.内置工具.html.d0be95a8.js" as="script" /><link rel="prefetch" href="/assets/0.函数重载.html.472f247a.js" as="script" /><link rel="prefetch" href="/assets/0.抽象类.html.73a87988.js" as="script" /><link rel="prefetch" href="/assets/0.断言函数.html.7367871f.js" as="script" /><link rel="prefetch" href="/assets/0.模板字符串.html.ff0f7d9a.js" as="script" /><link rel="prefetch" href="/assets/0.模板字符串工具.html.37bd6f59.js" as="script" /><link rel="prefetch" href="/assets/0.类型层级.html.d19219c6.js" as="script" /><link rel="prefetch" href="/assets/0.类的方法覆盖.html.a293b1d6.js" as="script" /><link rel="prefetch" href="/assets/0.静态类.html.8181c739.js" as="script" /><link rel="prefetch" href="/assets/100.实现对某个对象部分属性进行修饰.html.c90c47fd.js" as="script" /><link rel="prefetch" href="/assets/101.实现对象属性互斥类型工具.html.1c88a8bf.js" as="script" /><link rel="prefetch" href="/assets/102.实现对象类型的交叉并补集.html.c34a2ab0.js" as="script" /><link rel="prefetch" href="/assets/103.实现提取某个对象中必选属性.html.1b540263.js" as="script" /><link rel="prefetch" href="/assets/104.实现Pick和Omit函数对属性值提取.html.5493e78d.js" as="script" /><link rel="prefetch" href="/assets/105.实现对象数组深层修饰.html.d35935ad.js" as="script" /><link rel="prefetch" href="/assets/index.html.cec00e38.js" as="script" /><link rel="prefetch" href="/assets/HOOK.html.d697ab33.js" as="script" /><link rel="prefetch" href="/assets/index.html.644c3b34.js" as="script" /><link rel="prefetch" href="/assets/Ref.html.82fe80d4.js" as="script" /><link rel="prefetch" href="/assets/渲染原理.html.0965e517.js" as="script" /><link rel="prefetch" href="/assets/1.核心概念.html.c41f806b.js" as="script" /><link rel="prefetch" href="/assets/2.简单使用.html.35b02576.js" as="script" /><link rel="prefetch" href="/assets/3.实现简易Redux.html.e69c76e0.js" as="script" /><link rel="prefetch" href="/assets/4.中间件.html.efc8b7e4.js" as="script" /><link rel="prefetch" href="/assets/index.html.0390cf8c.js" as="script" /><link rel="prefetch" href="/assets/1.install.html.ff2fa99b.js" as="script" /><link rel="prefetch" href="/assets/2.VueRouter构造器.html.4daaa82a.js" as="script" /><link rel="prefetch" href="/assets/3.matcher.html.57e7a6fe.js" as="script" /><link rel="prefetch" href="/assets/index.html.f9ad7a4b.js" as="script" /><link rel="prefetch" href="/assets/index.html.c73209a9.js" as="script" /><link rel="prefetch" href="/assets/1.vnode到dom.html.32d400a2.js" as="script" /><link rel="prefetch" href="/assets/2.diff流程.html.3f7433e6.js" as="script" /><link rel="prefetch" href="/assets/3.setup.html.6464d607.js" as="script" /><link rel="prefetch" href="/assets/4.响应式.html.44b640e9.js" as="script" /><link rel="prefetch" href="/assets/index.html.b28797b1.js" as="script" /><link rel="prefetch" href="/assets/index.html.d4641eb2.js" as="script" /><link rel="prefetch" href="/assets/optimization.html.b1c39f99.js" as="script" /><link rel="prefetch" href="/assets/如何处理let为var.html.347b2682.js" as="script" /><link rel="prefetch" href="/assets/按需引入.html.a1796dd7.js" as="script" /><link rel="prefetch" href="/assets/index.html.34f02707.js" as="script" /><link rel="prefetch" href="/assets/http1.0、1.1、2.0、3.0的区别.html.6c1be5f5.js" as="script" /><link rel="prefetch" href="/assets/性能优化.html.e967da4a.js" as="script" /><link rel="prefetch" href="/assets/1.current.html.ee6a17a4.js" as="script" /><link rel="prefetch" href="/assets/2.confirmTransition.html.1e08f473.js" as="script" /><link rel="prefetch" href="/assets/3.路由守卫.html.893eaf6b.js" as="script" /><link rel="prefetch" href="/assets/4.url.html.9292353d.js" as="script" /><link rel="prefetch" href="/assets/5.内置组件.html.5418707b.js" as="script" /><link rel="prefetch" href="/assets/6.总结.html.63a80113.js" as="script" /><link rel="prefetch" href="/assets/index.html.24076b77.js" as="script" /><link rel="prefetch" href="/assets/1.目录结构.html.d9612b02.js" as="script" /><link rel="prefetch" href="/assets/2.源码构建.html.e031a84b.js" as="script" /><link rel="prefetch" href="/assets/3.vue入口.html.e6400f8b.js" as="script" /><link rel="prefetch" href="/assets/1.介绍.html.15428a35.js" as="script" /><link rel="prefetch" href="/assets/2.new Vue发生了什么.html.d10d2c80.js" as="script" /><link rel="prefetch" href="/assets/3.Vue._mount.html.b0dd29c7.js" as="script" /><link rel="prefetch" href="/assets/4.Vue._render.html.3a23c2dc.js" as="script" /><link rel="prefetch" href="/assets/5.VNode.html.f0e0b1a7.js" as="script" /><link rel="prefetch" href="/assets/6.createElement.html.64c5eb72.js" as="script" /><link rel="prefetch" href="/assets/7.Vue._update.html.47465e04.js" as="script" /><link rel="prefetch" href="/assets/1.介绍.html.3a17ad55.js" as="script" /><link rel="prefetch" href="/assets/2.响应式对象.html.ea1d4db3.js" as="script" /><link rel="prefetch" href="/assets/4.派发更新.html.ae5d0c6a.js" as="script" /><link rel="prefetch" href="/assets/5._nexttick.html.7edd0ede.js" as="script" /><link rel="prefetch" href="/assets/6.检测数据变化.html.2155d52d.js" as="script" /><link rel="prefetch" href="/assets/7.计算属性和监听属性.html.5b224810.js" as="script" /><link rel="prefetch" href="/assets/1.介绍.html.a23cd9c1.js" as="script" /><link rel="prefetch" href="/assets/2.createComponent.html.57dccc1a.js" as="script" /><link rel="prefetch" href="/assets/3.patch.html.a97ff2e4.js" as="script" /><link rel="prefetch" href="/assets/1.keep-alive.html.36b34e0c.js" as="script" /><link rel="prefetch" href="/assets/404.html.c5de7dd9.js" as="script" /><link rel="prefetch" href="/assets/index.html.2c89d7a1.js" as="script" /><link rel="prefetch" href="/assets/ES6和CommonJS模块化.html.1b3df876.js" as="script" /><link rel="prefetch" href="/assets/index.html.6b68a311.js" as="script" /><link rel="prefetch" href="/assets/包装类型.html.b6b457b7.js" as="script" /><link rel="prefetch" href="/assets/手写CommonJS.html.69b5b2dc.js" as="script" /><link rel="prefetch" href="/assets/手写Promise.html.9c97775a.js" as="script" /><link rel="prefetch" href="/assets/生成器.html.2137c5bc.js" as="script" /><link rel="prefetch" href="/assets/类型转换.html.ef4cb90c.js" as="script" /><link rel="prefetch" href="/assets/迭代器.html.e9946bad.js" as="script" /><link rel="prefetch" href="/assets/0.React中的TS集成.html.063517e8.js" as="script" /><link rel="prefetch" href="/assets/0.TSConfig配置.html.432b6aff.js" as="script" /><link rel="prefetch" href="/assets/0.infer关键字.html.a95448c5.js" as="script" /><link rel="prefetch" href="/assets/0.内置工具.html.f08316de.js" as="script" /><link rel="prefetch" href="/assets/0.函数重载.html.1102790d.js" as="script" /><link rel="prefetch" href="/assets/0.抽象类.html.727e4ade.js" as="script" /><link rel="prefetch" href="/assets/0.断言函数.html.c9c612bf.js" as="script" /><link rel="prefetch" href="/assets/0.模板字符串.html.75443447.js" as="script" /><link rel="prefetch" href="/assets/0.模板字符串工具.html.74aca23c.js" as="script" /><link rel="prefetch" href="/assets/0.类型层级.html.143c83c5.js" as="script" /><link rel="prefetch" href="/assets/0.类的方法覆盖.html.dfb1256b.js" as="script" /><link rel="prefetch" href="/assets/0.静态类.html.43b26a81.js" as="script" /><link rel="prefetch" href="/assets/100.实现对某个对象部分属性进行修饰.html.dd184ed8.js" as="script" /><link rel="prefetch" href="/assets/101.实现对象属性互斥类型工具.html.c65e5683.js" as="script" /><link rel="prefetch" href="/assets/102.实现对象类型的交叉并补集.html.63a5136a.js" as="script" /><link rel="prefetch" href="/assets/103.实现提取某个对象中必选属性.html.256b6053.js" as="script" /><link rel="prefetch" href="/assets/104.实现Pick和Omit函数对属性值提取.html.1a3a4d30.js" as="script" /><link rel="prefetch" href="/assets/105.实现对象数组深层修饰.html.5ef79a04.js" as="script" /><link rel="prefetch" href="/assets/index.html.0f50d2da.js" as="script" /><link rel="prefetch" href="/assets/HOOK.html.31093e5b.js" as="script" /><link rel="prefetch" href="/assets/index.html.92aa14b3.js" as="script" /><link rel="prefetch" href="/assets/Ref.html.dadb3e11.js" as="script" /><link rel="prefetch" href="/assets/渲染原理.html.40813145.js" as="script" /><link rel="prefetch" href="/assets/1.核心概念.html.9ca7e58d.js" as="script" /><link rel="prefetch" href="/assets/2.简单使用.html.be334732.js" as="script" /><link rel="prefetch" href="/assets/3.实现简易Redux.html.5404d971.js" as="script" /><link rel="prefetch" href="/assets/4.中间件.html.816326b4.js" as="script" /><link rel="prefetch" href="/assets/index.html.f15d1a10.js" as="script" /><link rel="prefetch" href="/assets/1.install.html.de1d4f22.js" as="script" /><link rel="prefetch" href="/assets/2.VueRouter构造器.html.6eadb60e.js" as="script" /><link rel="prefetch" href="/assets/3.matcher.html.97a53819.js" as="script" /><link rel="prefetch" href="/assets/index.html.9d0836aa.js" as="script" /><link rel="prefetch" href="/assets/index.html.266b5a3f.js" as="script" /><link rel="prefetch" href="/assets/1.vnode到dom.html.6d88c4c4.js" as="script" /><link rel="prefetch" href="/assets/2.diff流程.html.f8d88d50.js" as="script" /><link rel="prefetch" href="/assets/3.setup.html.a49ffe9b.js" as="script" /><link rel="prefetch" href="/assets/4.响应式.html.c4c70b9a.js" as="script" /><link rel="prefetch" href="/assets/index.html.e45ffebc.js" as="script" /><link rel="prefetch" href="/assets/index.html.22f74fb9.js" as="script" /><link rel="prefetch" href="/assets/optimization.html.bcaa7f29.js" as="script" /><link rel="prefetch" href="/assets/如何处理let为var.html.98f4f3b5.js" as="script" /><link rel="prefetch" href="/assets/按需引入.html.e1489e28.js" as="script" /><link rel="prefetch" href="/assets/index.html.efd612a9.js" as="script" /><link rel="prefetch" href="/assets/http1.0、1.1、2.0、3.0的区别.html.34b00bd1.js" as="script" /><link rel="prefetch" href="/assets/性能优化.html.5b363158.js" as="script" /><link rel="prefetch" href="/assets/1.current.html.615ba843.js" as="script" /><link rel="prefetch" href="/assets/2.confirmTransition.html.e0f18c0f.js" as="script" /><link rel="prefetch" href="/assets/3.路由守卫.html.fa35d094.js" as="script" /><link rel="prefetch" href="/assets/4.url.html.ad111fc7.js" as="script" /><link rel="prefetch" href="/assets/5.内置组件.html.7291d2d9.js" as="script" /><link rel="prefetch" href="/assets/6.总结.html.f79941f5.js" as="script" /><link rel="prefetch" href="/assets/index.html.1d444c5a.js" as="script" /><link rel="prefetch" href="/assets/1.目录结构.html.836b91c6.js" as="script" /><link rel="prefetch" href="/assets/2.源码构建.html.e68b20be.js" as="script" /><link rel="prefetch" href="/assets/3.vue入口.html.3774a898.js" as="script" /><link rel="prefetch" href="/assets/1.介绍.html.2fc15692.js" as="script" /><link rel="prefetch" href="/assets/2.new Vue发生了什么.html.73024452.js" as="script" /><link rel="prefetch" href="/assets/3.Vue._mount.html.f356355e.js" as="script" /><link rel="prefetch" href="/assets/4.Vue._render.html.a490651f.js" as="script" /><link rel="prefetch" href="/assets/5.VNode.html.a85b0350.js" as="script" /><link rel="prefetch" href="/assets/6.createElement.html.847cdf2e.js" as="script" /><link rel="prefetch" href="/assets/7.Vue._update.html.f01baaf2.js" as="script" /><link rel="prefetch" href="/assets/1.介绍.html.b83f26c0.js" as="script" /><link rel="prefetch" href="/assets/2.响应式对象.html.7aaf5220.js" as="script" /><link rel="prefetch" href="/assets/4.派发更新.html.3767f650.js" as="script" /><link rel="prefetch" href="/assets/5._nexttick.html.b3a0d6c2.js" as="script" /><link rel="prefetch" href="/assets/6.检测数据变化.html.45df22fa.js" as="script" /><link rel="prefetch" href="/assets/7.计算属性和监听属性.html.bfe7892e.js" as="script" /><link rel="prefetch" href="/assets/1.介绍.html.5c06c2a5.js" as="script" /><link rel="prefetch" href="/assets/2.createComponent.html.f5383b13.js" as="script" /><link rel="prefetch" href="/assets/3.patch.html.8b9599e6.js" as="script" /><link rel="prefetch" href="/assets/1.keep-alive.html.e64a9e8c.js" as="script" /><link rel="prefetch" href="/assets/404.html.c6c41902.js" as="script" /><link rel="prefetch" href="/assets/photoswipe.esm.720e8656.js" as="script" />
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><!----><!----><span class="site-name">marx的学习笔记</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/JS/" class="nav-link" aria-label="JS"><!---->JS<!----></a></div><div class="nav-item hide-in-mobile"><a href="/TS/" class="nav-link" aria-label="TS"><!---->TS<!----></a></div><div class="nav-item hide-in-mobile"><a href="/webpack/" class="nav-link" aria-label="webpack"><!---->webpack<!----></a></div><div class="nav-item hide-in-mobile"><a href="/react/" class="nav-link" aria-label="react"><!---->react<!----></a></div><div class="nav-item hide-in-mobile"><a href="/redux/" class="nav-link" aria-label="redux"><!---->redux<!----></a></div><div class="nav-item hide-in-mobile"><a href="/vue2%E6%BA%90%E7%A0%81/" class="nav-link active" aria-label="vue2源码"><!---->vue2源码<!----></a></div><div class="nav-item hide-in-mobile"><a href="/vue3%E6%BA%90%E7%A0%81/" class="nav-link" aria-label="vue3源码"><!---->vue3源码<!----></a></div><div class="nav-item hide-in-mobile"><a href="/vue-router3%E6%BA%90%E7%A0%81/" class="nav-link" aria-label="vue-router3源码"><!---->vue-router3源码<!----></a></div><div class="nav-item hide-in-mobile"><a href="/%E7%BD%91%E7%BB%9C/" class="nav-link" aria-label="网络"><!---->网络<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><!----><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/vue2%E6%BA%90%E7%A0%81/" class="nav-link sidebar-link sidebar-page" aria-label="首页"><!---->首页<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">1.准备</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">2.数据驱动</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">3.组件化</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">4.响应式</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/vue2%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F/7.%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7%E5%92%8C%E7%9B%91%E5%90%AC%E5%B1%9E%E6%80%A7.html" class="nav-link sidebar-link sidebar-page" aria-label="计算属性和监听属性"><!---->计算属性和监听属性<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/vue2%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F/6.%E6%A3%80%E6%B5%8B%E6%95%B0%E6%8D%AE%E5%8F%98%E5%8C%96.html" class="nav-link sidebar-link sidebar-page" aria-label="检测数据变化"><!---->检测数据变化<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/vue2%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F/1.%E4%BB%8B%E7%BB%8D.html" class="nav-link sidebar-link sidebar-page" aria-label="介绍"><!---->介绍<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/vue2%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F/4.%E6%B4%BE%E5%8F%91%E6%9B%B4%E6%96%B0.html" class="nav-link sidebar-link sidebar-page" aria-label="派发更新"><!---->派发更新<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/vue2%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F/2.%E5%93%8D%E5%BA%94%E5%BC%8F%E5%AF%B9%E8%B1%A1.html" class="nav-link sidebar-link sidebar-page" aria-label="响应式对象"><!---->响应式对象<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/vue2%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F/3.%E4%BE%9D%E8%B5%96%E6%94%B6%E9%9B%86.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="依赖收集"><!---->依赖收集<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/vue2%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F/3.%E4%BE%9D%E8%B5%96%E6%94%B6%E9%9B%86.html#dep" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Dep"><!---->Dep<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vue2%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F/3.%E4%BE%9D%E8%B5%96%E6%94%B6%E9%9B%86.html#watcher" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Watcher"><!---->Watcher<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vue2%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F/3.%E4%BE%9D%E8%B5%96%E6%94%B6%E9%9B%86.html#收集过程" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="收集过程"><!---->收集过程<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/vue2%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F/3.%E4%BE%9D%E8%B5%96%E6%94%B6%E9%9B%86.html#总结" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="总结"><!---->总结<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/vue2%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F/5.$nexttick.html" class="nav-link sidebar-link sidebar-page" aria-label="nexttick"><!---->nexttick<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">6.内置组件</span><span class="arrow right"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->依赖收集</h1><div class="page-info"><!----><!----><span class="date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2022-12-02T09:12:10.000Z"></span><!----><!----><span class="reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 8 分钟</span><meta property="timeRequired" content="PT8M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/vue2%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F/3.%E4%BE%9D%E8%B5%96%E6%94%B6%E9%9B%86.html#dep" class="router-link-active router-link-exact-active toc-link level2">Dep</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vue2%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F/3.%E4%BE%9D%E8%B5%96%E6%94%B6%E9%9B%86.html#watcher" class="router-link-active router-link-exact-active toc-link level2">Watcher</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vue2%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F/3.%E4%BE%9D%E8%B5%96%E6%94%B6%E9%9B%86.html#收集过程" class="router-link-active router-link-exact-active toc-link level2">收集过程</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/vue2%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F/3.%E4%BE%9D%E8%B5%96%E6%94%B6%E9%9B%86.html#总结" class="router-link-active router-link-exact-active toc-link level2">总结</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="依赖收集" tabindex="-1"><a class="header-anchor" href="#依赖收集" aria-hidden="true">#</a> 依赖收集</h1><p>上一章我们知道Vue在初始化（new Vue）的时候会将我们配置的data属性变成可观察对象，可观察对象的getter就是用来做依赖收集的，我们先回顾下getter中的逻辑</p><!----><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineReactive</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">obj</span><span class="token operator">:</span> Object<span class="token punctuation">,</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token literal-property property">val</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  customSetter<span class="token operator">?</span><span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span>
  shallow<span class="token operator">?</span><span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> property <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span>configurable <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// cater for pre-defined getter/setters</span>
  <span class="token keyword">const</span> getter <span class="token operator">=</span> property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span>get
  <span class="token keyword">const</span> setter <span class="token operator">=</span> property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span>set
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>getter <span class="token operator">||</span> setter<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> arguments<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    val <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 对象值可能也是一个对象，递归创建Observer实例</span>
  <span class="token keyword">let</span> childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 收集依赖</span>
        dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// 如果值为对象，则递归收集依赖</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>childOb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          childOb<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">dependArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span> <span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 暂时忽略</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>getter中重要的两个逻辑</p><ul><li>通过之前<code>const dep = new Dep()</code>的实例调用<code>dep.depend()</code>方法收集依赖，这里的dep实例是通过闭包保存</li><li>递归实现子元素依赖收集，这里的逻辑我们之后说</li></ul><h2 id="dep" tabindex="-1"><a class="header-anchor" href="#dep" aria-hidden="true">#</a> Dep</h2><p>Dep的作用就是收集依赖</p><!----><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">let</span> uid <span class="token operator">=</span> <span class="token number">0</span>

<span class="token doc-comment comment">/**
 * A dep is an observable that can have multiple
 * directives subscribing to it.
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token operator">?</span>Watcher<span class="token punctuation">;</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span> number<span class="token punctuation">;</span>
  <span class="token literal-property property">subs</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>Watcher<span class="token operator">&gt;</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> uid<span class="token operator">++</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 添加依赖</span>
  <span class="token function">addSub</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">sub</span><span class="token operator">:</span> Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 删除依赖</span>
  <span class="token function">removeSub</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">sub</span><span class="token operator">:</span> Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">,</span> sub<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 收集依赖</span>
  <span class="token function">depend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Dep.target实时上就是Watcher实例，全局唯一</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用实例上的addDep方法在Watcher实例上保存当前Dep（newDeps）</span>
      <span class="token comment">// 并且会调用当前Dep实例的addSub方法添加依赖</span>
      Dep<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 更新依赖</span>
  <span class="token function">notify</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// stabilize the subscriber list first</span>
    <span class="token keyword">const</span> subs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&#39;production&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>config<span class="token punctuation">.</span>async<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// subs aren&#39;t sorted in scheduler if not running async</span>
      <span class="token comment">// we need to sort them now to make sure they fire in correct</span>
      <span class="token comment">// order</span>
      subs<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span>id <span class="token operator">-</span> b<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> subs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      subs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// The current target watcher being evaluated.</span>
<span class="token comment">// This is globally unique because only one watcher</span>
<span class="token comment">// can be evaluated at a time.</span>
Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">const</span> targetStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">pushTarget</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token operator">?</span>Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  targetStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> target
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">popTarget</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  targetStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> targetStack<span class="token punctuation">[</span>targetStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Dep</code>上有一个静态属性<code>target</code>， 这个属性是每个Vue实例唯一的，为观察者<code>Watcher</code>，包括<code>subs</code>也是<code>Watcher</code>数组</p><p><code>Dep</code>是对<code>Watcher</code>的一种管理，会通知<code>Watcher</code>：“数据变化了，该更新视图了”</p><p>我们需要了解<code>Watcher</code>才能知道整个依赖收集过程</p><h2 id="watcher" tabindex="-1"><a class="header-anchor" href="#watcher" aria-hidden="true">#</a> Watcher</h2><!----><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">let</span> uid <span class="token operator">=</span> <span class="token number">0</span>

<span class="token doc-comment comment">/**
 * A watcher parses an expression, collects dependencies,
 * and fires callback when the expression value changes.
 * This is used for both the $watch() api and directives.
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>

  <span class="token function">constructor</span> <span class="token punctuation">(</span>
    <span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component<span class="token punctuation">,</span>
    <span class="token literal-property property">expOrFn</span><span class="token operator">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span>
    <span class="token literal-property property">cb</span><span class="token operator">:</span> Function<span class="token punctuation">,</span>
    options<span class="token operator">?</span><span class="token operator">:</span> <span class="token operator">?</span>Object<span class="token punctuation">,</span>
    isRenderWatcher<span class="token operator">?</span><span class="token operator">:</span> boolean</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isRenderWatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>_watcher <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
    vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token comment">// options</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>deep <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>deep
      <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>user
      <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy
      <span class="token keyword">this</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>sync
      <span class="token keyword">this</span><span class="token punctuation">.</span>before <span class="token operator">=</span> options<span class="token punctuation">.</span>before
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>deep <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token operator">++</span>uid <span class="token comment">// uid for batching</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token comment">// for lazy watchers</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>depIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>expression <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&#39;production&#39;</span>
      <span class="token operator">?</span> expOrFn<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token string">&#39;&#39;</span>
    <span class="token comment">// parse expression for getter</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> expOrFn <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> expOrFn
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>getter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> noop
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy
      <span class="token operator">?</span> <span class="token keyword">undefined</span>
      <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Evaluate the getter, and re-collect dependencies.
   */</span>
  <span class="token function">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Add a dependency to this directive.
   */</span>
  <span class="token function">addDep</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">dep</span><span class="token operator">:</span> Dep</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Clean up for dependency collection.
   */</span>
  <span class="token function">cleanupDeps</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Subscriber interface.
   * Will be called when a dependency changes.
   */</span>
  <span class="token function">update</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Scheduler job interface.
   * Will be called by the scheduler.
   */</span>
  <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Evaluate the value of the watcher.
   * This only gets called for lazy watchers.
   */</span>
  <span class="token function">evaluate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Depend on all deps collected by this watcher.
   */</span>
  <span class="token function">depend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * Remove self from all dependencies&#39; subscriber list.
   */</span>
  <span class="token function">teardown</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Watcher</code>中定义了一些<code>Dep</code>相关的属性和方法</p><ul><li><code>deps</code>、<code>newDeps</code>、<code>depIds</code>、<code>newDepIds</code>属性就是存放<code>Dep</code>的列表以及id，至于为什么会整两套，我们稍后再说</li><li><code>get</code>、<code>addDep</code>、<code>cleanupDeps</code>是依赖收集的相关方法，我们稍后再说</li></ul><h2 id="收集过程" tabindex="-1"><a class="header-anchor" href="#收集过程" aria-hidden="true">#</a> 收集过程</h2><p>依赖是从触发<code>$mount</code>开始的，我们之前分析过<code>$mount</code>最终会调用<code>mountComponent</code>方法</p><!----><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mountComponent</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component<span class="token punctuation">,</span>
  <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token operator">?</span>Element<span class="token punctuation">,</span>
  hydrating<span class="token operator">?</span><span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Component <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function-variable function">updateComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// we set this to vm._watcher inside the watcher&#39;s constructor</span>
  <span class="token comment">// since the watcher&#39;s initial patch may call $forceUpdate (e.g. inside child</span>
  <span class="token comment">// component&#39;s mounted hook), which relies on vm._watcher being already defined</span>
  <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> updateComponent<span class="token punctuation">,</span> noop<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">before</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_isMounted <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>_isDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">&#39;beforeUpdate&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* isRenderWatcher */</span><span class="token punctuation">)</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在挂载过程我们会实例化一个<code>Watcher</code>，我们回到<code>Watcher</code>函数中</p><!----><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>

  <span class="token function">constructor</span> <span class="token punctuation">(</span>
    <span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component<span class="token punctuation">,</span>
    <span class="token literal-property property">expOrFn</span><span class="token operator">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span>
    <span class="token literal-property property">cb</span><span class="token operator">:</span> Function<span class="token punctuation">,</span>
    options<span class="token operator">?</span><span class="token operator">:</span> <span class="token operator">?</span>Object<span class="token punctuation">,</span>
    isRenderWatcher<span class="token operator">?</span><span class="token operator">:</span> boolean</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy
      <span class="token operator">?</span> <span class="token keyword">undefined</span>
      <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...</span>

  <span class="token doc-comment comment">/**
   * Evaluate the getter, and re-collect dependencies.
   */</span>
  <span class="token function">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实例化<code>Watcher</code>的过程中会调用<code>get</code>方法，而<code>get</code>中先调用了<code>pushTarget(this)</code></p><!----><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// The current target watcher being evaluated.</span>
<span class="token comment">// This is globally unique because only one watcher</span>
<span class="token comment">// can be evaluated at a time.</span>
Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">const</span> targetStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">pushTarget</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token operator">?</span>Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  targetStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> target
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过<code>pushTarget(this)</code>方法赋值<code>Dep.target</code>，并把<code>Watcher</code>实例压栈</p><p>接着我们继续分析<code>Watcher</code>的<code>get</code>方法</p><!----><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span>
    <span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component<span class="token punctuation">,</span>
    <span class="token literal-property property">expOrFn</span><span class="token operator">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span>
    <span class="token literal-property property">cb</span><span class="token operator">:</span> Function<span class="token punctuation">,</span>
    options<span class="token operator">?</span><span class="token operator">:</span> <span class="token operator">?</span>Object<span class="token punctuation">,</span>
    isRenderWatcher<span class="token operator">?</span><span class="token operator">:</span> boolean</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// parse expression for getter</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> expOrFn <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> expOrFn
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>getter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> noop
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy
      <span class="token operator">?</span> <span class="token keyword">undefined</span>
      <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> value
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> value
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着调用<code>Watcher</code>的<code>getter</code>属性，其实就是在<code>mountComponent</code>函数中传入的</p><!----><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>  <span class="token function-variable function">updateComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>先执行<code>vm._render()</code>因为之前分析过这个方法会生成 渲染 VNode，并且在这个过程中会对当前vue实例上的数据访问，这个时候就触发了数据对象的<code>getter</code></p><p>每一个对象数据都有一个<code>Dep</code>实例，在触发<code>getter</code>的时候会调用<code>dep.depend()</code>方法</p><!----><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>  <span class="token function">depend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Dep<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实际上就是调用全实例唯一的<code>Watcher</code>实例的<code>addDep</code>方法</p><!----><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">addDep</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">dep</span><span class="token operator">:</span> Dep</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> dep<span class="token punctuation">.</span>id
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>depIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先<code>Watcher</code>会判断阻止<code>Dep</code>实例被添加多次，后执行<code>dep.addSub(this)</code></p><!----><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>  <span class="token function">addSub</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">sub</span><span class="token operator">:</span> Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>也就是说将<code>Watcher</code>实例添加到<code>Dep</code>实例的<code>subs</code>属性上，目的是后续变化可以通过<code>subs</code>属性去通知<code>Watcher</code>实例数据变化了</p><p>所以在<code>vm._render()</code>的过程中会触发所有数据的<code>getter</code>，这样就完成了大部分依赖收集的工作，接着我们回到<code>Watcher</code>执行<code>get</code>这里接着分析</p><!----><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>  <span class="token function">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> value
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">getter for watcher &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> e
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token comment">// &quot;touch&quot; every property so they are all tracked as</span>
      <span class="token comment">// dependencies for deep watching</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cleanupDeps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> value
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>通过<code>traverse(value)</code>回去递归触发子属性的<code>getter</code>，我们稍后说</li><li>之后运行<code>popTarget()</code>将<code>Watcher</code>出栈</li></ul><!----><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">const</span> targetStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">popTarget</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  targetStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> targetStack<span class="token punctuation">[</span>targetStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实际上就是<code>Dep.target</code>恢复成上一个状态，因为当前vue实例的数据依赖收集已经完成</p><!----><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cleanupDeps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>接着就是清空之前依赖</p><!----><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">cleanupDeps</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>dep<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dep<span class="token punctuation">.</span><span class="token function">removeSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>depIds
  <span class="token keyword">this</span><span class="token punctuation">.</span>depIds <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds
  <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds <span class="token operator">=</span> tmp
  <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps
  <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps
  <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps <span class="token operator">=</span> tmp
  <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Vue是数据驱动的，每次数据变化都会触发<code>vm._render()</code>并重新触发数据的<code>getter</code>，所以<code>Watcher</code>会在实例化的时候生成两套用来存放<code>Dep</code>实例和id的数组，<code>newDeps</code>就表示新的，而<code>deps</code>就代表老的</p><p>在执行<code>cleanupDeps</code>时首先会移除<code>dep.subs</code>中的<code>Watcher</code>，然后在将旧的<code>deps</code>赋值新的<code>newDeps</code>列表，并将新的置空</p><p>明明已经在<code>addDep</code>判断重复id了这里在清除有什么作用呢</p><p>例如有一种场景，通过<code>v-if</code>去控制组件<code>A</code>和<code>B</code>的渲染，两个组件分别传有自己的数据</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>A</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>isShow<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:aData</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aData<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>B</span> <span class="token attr-name">v-else</span> <span class="token attr-name">:bData</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bData<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>我们在初始化的时候渲染了组件<code>A</code>，就触发了<code>A</code>中数据的<code>getter</code>，完成了依赖收集，这里用props举例，我们在修改<code>aData</code>的时候会通知数据的观察者。如果我们修改<code>isShow</code>渲染了组件<code>B</code>，那么也会触发<code>B</code>中数据的<code>getter</code>，那么这时候<code>aData</code>变化了会通知<code>A</code>数据对应的观察者触发重新渲染，这显然是没有意义的。</p><p>因此Vue设计了每次收集依赖的时候都会移除旧的依赖，这样就保证了在刚才的场景中不会有额外的渲染开销</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>这章我们分析收集依赖的过程，在触发<code>setter</code>的时候也需要通知相应的依赖更新，下一章我们就分析派发更新的过程</p></div><!----><footer class="page-meta"><!----><div class="meta-item update-time"><span class="label">上次编辑于: </span><!----></div><div class="meta-item contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: marx10086@gmail.com">marx</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/vue2%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F/2.%E5%93%8D%E5%BA%94%E5%BC%8F%E5%AF%B9%E8%B1%A1.html" class="nav-link prev" aria-label="响应式对象"><div class="hint"><span class="arrow left"></span>上一页</div><div class="link"><!---->响应式对象</div></a><a href="/vue2%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F/5.$nexttick.html" class="nav-link next" aria-label="nexttick"><div class="hint">下一页<span class="arrow right"></span></div><div class="link">nexttick<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.9ac9284b.js" defer></script>
  </body>
</html>
