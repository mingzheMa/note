<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.53" />
    <meta name="theme" content="VuePress Theme Hope" />
    <title>å“åº”å¼ | marxçš„å­¦ä¹ ç¬”è®°</title><meta name="description" content="éƒ¨åˆ†å†…å®¹æ˜¯å‚è€ƒå¤–éƒ¨æ–‡ç« ï¼Œå±äºä¸ªäººå¤ä¹ ä½¿ç”¨">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/note/assets/style.31e87fe8.css" as="style" /><link rel="stylesheet" href="/note/assets/style.31e87fe8.css" />
    <link rel="modulepreload" href="/note/assets/app.002a81c8.js"><link rel="modulepreload" href="/note/assets/4.å“åº”å¼.html.cbd0936d.js"><link rel="modulepreload" href="/note/assets/_plugin-vue_export-helper.cdc0426e.js"><link rel="modulepreload" href="/note/assets/4.å“åº”å¼.html.6333cda8.js"><link rel="prefetch" href="/note/assets/index.html.6c946c9f.js" as="script" /><link rel="prefetch" href="/note/assets/ES6å’ŒCommonJSæ¨¡å—åŒ–.html.993609d3.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.c3b5ae80.js" as="script" /><link rel="prefetch" href="/note/assets/indexedDB.html.c8a10585.js" as="script" /><link rel="prefetch" href="/note/assets/åŒ…è£…ç±»å‹.html.6ad5c91c.js" as="script" /><link rel="prefetch" href="/note/assets/å¾ªç¯.html.6c09574e.js" as="script" /><link rel="prefetch" href="/note/assets/æ‰‹å†™CommonJS.html.1498b864.js" as="script" /><link rel="prefetch" href="/note/assets/æ‰‹å†™Promise.html.a9d665da.js" as="script" /><link rel="prefetch" href="/note/assets/ç”Ÿæˆå™¨.html.30c11bf8.js" as="script" /><link rel="prefetch" href="/note/assets/ç±»å‹è½¬æ¢.html.1c90490a.js" as="script" /><link rel="prefetch" href="/note/assets/è¿ç®—ç¬¦.html.7cbf200a.js" as="script" /><link rel="prefetch" href="/note/assets/è¿­ä»£å™¨.html.09e1ba62.js" as="script" /><link rel="prefetch" href="/note/assets/0.Reactä¸­çš„TSé›†æˆ.html.72297c73.js" as="script" /><link rel="prefetch" href="/note/assets/0.TSConfigé…ç½®.html.8e862c7f.js" as="script" /><link rel="prefetch" href="/note/assets/0.inferå…³é”®å­—.html.2de3f009.js" as="script" /><link rel="prefetch" href="/note/assets/0.å†…ç½®å·¥å…·.html.d0be95a8.js" as="script" /><link rel="prefetch" href="/note/assets/0.å‡½æ•°é‡è½½.html.472f247a.js" as="script" /><link rel="prefetch" href="/note/assets/0.æŠ½è±¡ç±».html.73a87988.js" as="script" /><link rel="prefetch" href="/note/assets/0.æ–­è¨€å‡½æ•°.html.7e02431c.js" as="script" /><link rel="prefetch" href="/note/assets/0.æ¨¡æ¿å­—ç¬¦ä¸².html.ff0f7d9a.js" as="script" /><link rel="prefetch" href="/note/assets/0.æ¨¡æ¿å­—ç¬¦ä¸²å·¥å…·.html.37bd6f59.js" as="script" /><link rel="prefetch" href="/note/assets/0.ç±»å‹å±‚çº§.html.d19219c6.js" as="script" /><link rel="prefetch" href="/note/assets/0.ç±»çš„æ–¹æ³•è¦†ç›–.html.a293b1d6.js" as="script" /><link rel="prefetch" href="/note/assets/0.é™æ€ç±».html.8181c739.js" as="script" /><link rel="prefetch" href="/note/assets/100.å®ç°å¯¹æŸä¸ªå¯¹è±¡éƒ¨åˆ†å±æ€§è¿›è¡Œä¿®é¥°.html.c90c47fd.js" as="script" /><link rel="prefetch" href="/note/assets/101.å®ç°å¯¹è±¡å±æ€§äº’æ–¥ç±»å‹å·¥å…·.html.1c88a8bf.js" as="script" /><link rel="prefetch" href="/note/assets/102.å®ç°å¯¹è±¡ç±»å‹çš„äº¤å‰å¹¶è¡¥é›†.html.c34a2ab0.js" as="script" /><link rel="prefetch" href="/note/assets/103.å®ç°æå–æŸä¸ªå¯¹è±¡ä¸­å¿…é€‰å±æ€§.html.1b540263.js" as="script" /><link rel="prefetch" href="/note/assets/104.å®ç°Pickå’ŒOmitå‡½æ•°å¯¹å±æ€§å€¼æå–.html.5493e78d.js" as="script" /><link rel="prefetch" href="/note/assets/105.å®ç°å¯¹è±¡æ•°ç»„æ·±å±‚ä¿®é¥°.html.d35935ad.js" as="script" /><link rel="prefetch" href="/note/assets/106.å®ç°è§£æURLå‚æ•°.html.f9754bc4.js" as="script" /><link rel="prefetch" href="/note/assets/99.type-challenges.html.972c803b.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.cec00e38.js" as="script" /><link rel="prefetch" href="/note/assets/HOOK.html.d697ab33.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.644c3b34.js" as="script" /><link rel="prefetch" href="/note/assets/Ref.html.82fe80d4.js" as="script" /><link rel="prefetch" href="/note/assets/æ¸²æŸ“åŸç†.html.0965e517.js" as="script" /><link rel="prefetch" href="/note/assets/1.æ ¸å¿ƒæ¦‚å¿µ.html.c41f806b.js" as="script" /><link rel="prefetch" href="/note/assets/2.ç®€å•ä½¿ç”¨.html.35b02576.js" as="script" /><link rel="prefetch" href="/note/assets/3.å®ç°ç®€æ˜“Redux.html.e69c76e0.js" as="script" /><link rel="prefetch" href="/note/assets/4.ä¸­é—´ä»¶.html.efc8b7e4.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.0390cf8c.js" as="script" /><link rel="prefetch" href="/note/assets/1.é¡¹ç›®æ„å»º.html.46395daf.js" as="script" /><link rel="prefetch" href="/note/assets/2.csså·¥ç¨‹åŒ–.html.8346221e.js" as="script" /><link rel="prefetch" href="/note/assets/3.æ¥å…¥ESLint.html.bd4f3b49.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.c01df283.js" as="script" /><link rel="prefetch" href="/note/assets/1.install.html.ff2fa99b.js" as="script" /><link rel="prefetch" href="/note/assets/2.VueRouteræ„é€ å™¨.html.4daaa82a.js" as="script" /><link rel="prefetch" href="/note/assets/3.matcher.html.57e7a6fe.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.f9ad7a4b.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.c73209a9.js" as="script" /><link rel="prefetch" href="/note/assets/1.vnodeåˆ°dom.html.32d400a2.js" as="script" /><link rel="prefetch" href="/note/assets/100.é¡¹ç›®æ„å»º.html.e929feeb.js" as="script" /><link rel="prefetch" href="/note/assets/2.diffæµç¨‹.html.6096dd78.js" as="script" /><link rel="prefetch" href="/note/assets/3.setup.html.0cbe3bc3.js" as="script" /><link rel="prefetch" href="/note/assets/5.è®¡ç®—å±æ€§.html.1deab00e.js" as="script" /><link rel="prefetch" href="/note/assets/6.ç›‘å¬å™¨.html.9e4328c2.js" as="script" /><link rel="prefetch" href="/note/assets/7.å¼‚æ­¥é˜Ÿåˆ—.html.1e11bab4.js" as="script" /><link rel="prefetch" href="/note/assets/8.ç”Ÿå‘½å‘¨æœŸé’©å­.html.ce05d4d9.js" as="script" /><link rel="prefetch" href="/note/assets/9.ä¾èµ–æ³¨å…¥.html.ae06bc47.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.b28797b1.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.d4641eb2.js" as="script" /><link rel="prefetch" href="/note/assets/optimization.html.b1c39f99.js" as="script" /><link rel="prefetch" href="/note/assets/å¦‚ä½•å¤„ç†letä¸ºvar.html.347b2682.js" as="script" /><link rel="prefetch" href="/note/assets/æŒ‰éœ€å¼•å…¥.html.a1796dd7.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.34f02707.js" as="script" /><link rel="prefetch" href="/note/assets/http1.0ã€1.1ã€2.0ã€3.0çš„åŒºåˆ«.html.6c1be5f5.js" as="script" /><link rel="prefetch" href="/note/assets/æ€§èƒ½ä¼˜åŒ–.html.e967da4a.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.c8bbff92.js" as="script" /><link rel="prefetch" href="/note/assets/1.current.html.ee6a17a4.js" as="script" /><link rel="prefetch" href="/note/assets/2.confirmTransition.html.1e08f473.js" as="script" /><link rel="prefetch" href="/note/assets/3.è·¯ç”±å®ˆå«.html.893eaf6b.js" as="script" /><link rel="prefetch" href="/note/assets/4.url.html.9292353d.js" as="script" /><link rel="prefetch" href="/note/assets/5.å†…ç½®ç»„ä»¶.html.5418707b.js" as="script" /><link rel="prefetch" href="/note/assets/6.æ€»ç»“.html.63a80113.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.24076b77.js" as="script" /><link rel="prefetch" href="/note/assets/1.ç›®å½•ç»“æ„.html.d9612b02.js" as="script" /><link rel="prefetch" href="/note/assets/2.æºç æ„å»º.html.e031a84b.js" as="script" /><link rel="prefetch" href="/note/assets/3.vueå…¥å£.html.e6400f8b.js" as="script" /><link rel="prefetch" href="/note/assets/1.ä»‹ç».html.15428a35.js" as="script" /><link rel="prefetch" href="/note/assets/2.new Vueå‘ç”Ÿäº†ä»€ä¹ˆ.html.ffc7e372.js" as="script" /><link rel="prefetch" href="/note/assets/3.Vue._mount.html.f6f138d2.js" as="script" /><link rel="prefetch" href="/note/assets/4.Vue._render.html.e91241ea.js" as="script" /><link rel="prefetch" href="/note/assets/5.VNode.html.a9e8a3e2.js" as="script" /><link rel="prefetch" href="/note/assets/6.createElement.html.203ebab0.js" as="script" /><link rel="prefetch" href="/note/assets/7.Vue._update.html.d4975f38.js" as="script" /><link rel="prefetch" href="/note/assets/1.ä»‹ç».html.a23cd9c1.js" as="script" /><link rel="prefetch" href="/note/assets/2.createComponent.html.57dccc1a.js" as="script" /><link rel="prefetch" href="/note/assets/3.patch.html.a97ff2e4.js" as="script" /><link rel="prefetch" href="/note/assets/1.ä»‹ç».html.3a17ad55.js" as="script" /><link rel="prefetch" href="/note/assets/2.å“åº”å¼å¯¹è±¡.html.ea1d4db3.js" as="script" /><link rel="prefetch" href="/note/assets/3.ä¾èµ–æ”¶é›†.html.7b50dfa2.js" as="script" /><link rel="prefetch" href="/note/assets/4.æ´¾å‘æ›´æ–°.html.ae5d0c6a.js" as="script" /><link rel="prefetch" href="/note/assets/5._nexttick.html.7edd0ede.js" as="script" /><link rel="prefetch" href="/note/assets/6.æ£€æµ‹æ•°æ®å˜åŒ–.html.2155d52d.js" as="script" /><link rel="prefetch" href="/note/assets/7.è®¡ç®—å±æ€§å’Œç›‘å¬å±æ€§.html.5b224810.js" as="script" /><link rel="prefetch" href="/note/assets/1.keep-alive.html.36b34e0c.js" as="script" /><link rel="prefetch" href="/note/assets/å“åº”å¼.html.b1602ed1.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.4be7c4be.js" as="script" /><link rel="prefetch" href="/note/assets/vueæ›´æ–°ç²’åº¦å¦‚ä½•æ§åˆ¶åœ¨ç»„ä»¶çº§åˆ«.html.0c9c3af5.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.ef1b8444.js" as="script" /><link rel="prefetch" href="/note/assets/hashå’Œhistoryä¼˜ç¼ºç‚¹.html.c381588f.js" as="script" /><link rel="prefetch" href="/note/assets/404.html.c5de7dd9.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.45ed5f7d.js" as="script" /><link rel="prefetch" href="/note/assets/ES6å’ŒCommonJSæ¨¡å—åŒ–.html.e34e6387.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.3a6a05c2.js" as="script" /><link rel="prefetch" href="/note/assets/indexedDB.html.486cad56.js" as="script" /><link rel="prefetch" href="/note/assets/åŒ…è£…ç±»å‹.html.c68366e8.js" as="script" /><link rel="prefetch" href="/note/assets/å¾ªç¯.html.e101299b.js" as="script" /><link rel="prefetch" href="/note/assets/æ‰‹å†™CommonJS.html.1836c47d.js" as="script" /><link rel="prefetch" href="/note/assets/æ‰‹å†™Promise.html.5bf5f6b0.js" as="script" /><link rel="prefetch" href="/note/assets/ç”Ÿæˆå™¨.html.8ed161ba.js" as="script" /><link rel="prefetch" href="/note/assets/ç±»å‹è½¬æ¢.html.92e8fa87.js" as="script" /><link rel="prefetch" href="/note/assets/è¿ç®—ç¬¦.html.3c13b47c.js" as="script" /><link rel="prefetch" href="/note/assets/è¿­ä»£å™¨.html.e7ed0694.js" as="script" /><link rel="prefetch" href="/note/assets/0.Reactä¸­çš„TSé›†æˆ.html.6ad62cb2.js" as="script" /><link rel="prefetch" href="/note/assets/0.TSConfigé…ç½®.html.4c2db2af.js" as="script" /><link rel="prefetch" href="/note/assets/0.inferå…³é”®å­—.html.6b8da2a2.js" as="script" /><link rel="prefetch" href="/note/assets/0.å†…ç½®å·¥å…·.html.e6e81e31.js" as="script" /><link rel="prefetch" href="/note/assets/0.å‡½æ•°é‡è½½.html.fc5d6aa5.js" as="script" /><link rel="prefetch" href="/note/assets/0.æŠ½è±¡ç±».html.8e946822.js" as="script" /><link rel="prefetch" href="/note/assets/0.æ–­è¨€å‡½æ•°.html.04ce2893.js" as="script" /><link rel="prefetch" href="/note/assets/0.æ¨¡æ¿å­—ç¬¦ä¸².html.55168d0c.js" as="script" /><link rel="prefetch" href="/note/assets/0.æ¨¡æ¿å­—ç¬¦ä¸²å·¥å…·.html.c2e84ead.js" as="script" /><link rel="prefetch" href="/note/assets/0.ç±»å‹å±‚çº§.html.2a734992.js" as="script" /><link rel="prefetch" href="/note/assets/0.ç±»çš„æ–¹æ³•è¦†ç›–.html.ec1822ee.js" as="script" /><link rel="prefetch" href="/note/assets/0.é™æ€ç±».html.f7fe831e.js" as="script" /><link rel="prefetch" href="/note/assets/100.å®ç°å¯¹æŸä¸ªå¯¹è±¡éƒ¨åˆ†å±æ€§è¿›è¡Œä¿®é¥°.html.4c99c1e6.js" as="script" /><link rel="prefetch" href="/note/assets/101.å®ç°å¯¹è±¡å±æ€§äº’æ–¥ç±»å‹å·¥å…·.html.df9aa9a8.js" as="script" /><link rel="prefetch" href="/note/assets/102.å®ç°å¯¹è±¡ç±»å‹çš„äº¤å‰å¹¶è¡¥é›†.html.96120ab4.js" as="script" /><link rel="prefetch" href="/note/assets/103.å®ç°æå–æŸä¸ªå¯¹è±¡ä¸­å¿…é€‰å±æ€§.html.77950696.js" as="script" /><link rel="prefetch" href="/note/assets/104.å®ç°Pickå’ŒOmitå‡½æ•°å¯¹å±æ€§å€¼æå–.html.e5f0083f.js" as="script" /><link rel="prefetch" href="/note/assets/105.å®ç°å¯¹è±¡æ•°ç»„æ·±å±‚ä¿®é¥°.html.37b71c5d.js" as="script" /><link rel="prefetch" href="/note/assets/106.å®ç°è§£æURLå‚æ•°.html.27b2c9ca.js" as="script" /><link rel="prefetch" href="/note/assets/99.type-challenges.html.5fcf4f3a.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.4fec250c.js" as="script" /><link rel="prefetch" href="/note/assets/HOOK.html.8c5e17a8.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.b1df8b96.js" as="script" /><link rel="prefetch" href="/note/assets/Ref.html.84a0fd5d.js" as="script" /><link rel="prefetch" href="/note/assets/æ¸²æŸ“åŸç†.html.379ac5ef.js" as="script" /><link rel="prefetch" href="/note/assets/1.æ ¸å¿ƒæ¦‚å¿µ.html.b9dbdbe9.js" as="script" /><link rel="prefetch" href="/note/assets/2.ç®€å•ä½¿ç”¨.html.e557e0d9.js" as="script" /><link rel="prefetch" href="/note/assets/3.å®ç°ç®€æ˜“Redux.html.02412614.js" as="script" /><link rel="prefetch" href="/note/assets/4.ä¸­é—´ä»¶.html.8c241230.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.2c708232.js" as="script" /><link rel="prefetch" href="/note/assets/1.é¡¹ç›®æ„å»º.html.4256751b.js" as="script" /><link rel="prefetch" href="/note/assets/2.csså·¥ç¨‹åŒ–.html.af756110.js" as="script" /><link rel="prefetch" href="/note/assets/3.æ¥å…¥ESLint.html.08e58d8b.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.b0493fce.js" as="script" /><link rel="prefetch" href="/note/assets/1.install.html.e232e2dc.js" as="script" /><link rel="prefetch" href="/note/assets/2.VueRouteræ„é€ å™¨.html.0b4321d2.js" as="script" /><link rel="prefetch" href="/note/assets/3.matcher.html.886bd4a1.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.1508f14b.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.463c5d87.js" as="script" /><link rel="prefetch" href="/note/assets/1.vnodeåˆ°dom.html.c13939dc.js" as="script" /><link rel="prefetch" href="/note/assets/100.é¡¹ç›®æ„å»º.html.c5843798.js" as="script" /><link rel="prefetch" href="/note/assets/2.diffæµç¨‹.html.8dd2e794.js" as="script" /><link rel="prefetch" href="/note/assets/3.setup.html.bca5554a.js" as="script" /><link rel="prefetch" href="/note/assets/5.è®¡ç®—å±æ€§.html.62692b37.js" as="script" /><link rel="prefetch" href="/note/assets/6.ç›‘å¬å™¨.html.d7f7f25b.js" as="script" /><link rel="prefetch" href="/note/assets/7.å¼‚æ­¥é˜Ÿåˆ—.html.4bfebd27.js" as="script" /><link rel="prefetch" href="/note/assets/8.ç”Ÿå‘½å‘¨æœŸé’©å­.html.6e698415.js" as="script" /><link rel="prefetch" href="/note/assets/9.ä¾èµ–æ³¨å…¥.html.fcb908a9.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.19a51118.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.02516bac.js" as="script" /><link rel="prefetch" href="/note/assets/optimization.html.7c8c6707.js" as="script" /><link rel="prefetch" href="/note/assets/å¦‚ä½•å¤„ç†letä¸ºvar.html.fc4fa984.js" as="script" /><link rel="prefetch" href="/note/assets/æŒ‰éœ€å¼•å…¥.html.eccdc77b.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.210e7d99.js" as="script" /><link rel="prefetch" href="/note/assets/http1.0ã€1.1ã€2.0ã€3.0çš„åŒºåˆ«.html.806bb893.js" as="script" /><link rel="prefetch" href="/note/assets/æ€§èƒ½ä¼˜åŒ–.html.958cae0c.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.4ecefa1a.js" as="script" /><link rel="prefetch" href="/note/assets/1.current.html.e3e49497.js" as="script" /><link rel="prefetch" href="/note/assets/2.confirmTransition.html.7794c09a.js" as="script" /><link rel="prefetch" href="/note/assets/3.è·¯ç”±å®ˆå«.html.2f41bdeb.js" as="script" /><link rel="prefetch" href="/note/assets/4.url.html.511dacc3.js" as="script" /><link rel="prefetch" href="/note/assets/5.å†…ç½®ç»„ä»¶.html.c3746686.js" as="script" /><link rel="prefetch" href="/note/assets/6.æ€»ç»“.html.f277e7a5.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.5f81f194.js" as="script" /><link rel="prefetch" href="/note/assets/1.ç›®å½•ç»“æ„.html.816b5e18.js" as="script" /><link rel="prefetch" href="/note/assets/2.æºç æ„å»º.html.a25affc8.js" as="script" /><link rel="prefetch" href="/note/assets/3.vueå…¥å£.html.7c0cd77c.js" as="script" /><link rel="prefetch" href="/note/assets/1.ä»‹ç».html.dfd9d380.js" as="script" /><link rel="prefetch" href="/note/assets/2.new Vueå‘ç”Ÿäº†ä»€ä¹ˆ.html.f9ff4af7.js" as="script" /><link rel="prefetch" href="/note/assets/3.Vue._mount.html.1c590864.js" as="script" /><link rel="prefetch" href="/note/assets/4.Vue._render.html.7d29cec2.js" as="script" /><link rel="prefetch" href="/note/assets/5.VNode.html.a948faae.js" as="script" /><link rel="prefetch" href="/note/assets/6.createElement.html.fedf547c.js" as="script" /><link rel="prefetch" href="/note/assets/7.Vue._update.html.915d9ea9.js" as="script" /><link rel="prefetch" href="/note/assets/1.ä»‹ç».html.4e56cb90.js" as="script" /><link rel="prefetch" href="/note/assets/2.createComponent.html.3d111296.js" as="script" /><link rel="prefetch" href="/note/assets/3.patch.html.e30dd072.js" as="script" /><link rel="prefetch" href="/note/assets/1.ä»‹ç».html.b228538f.js" as="script" /><link rel="prefetch" href="/note/assets/2.å“åº”å¼å¯¹è±¡.html.ca078649.js" as="script" /><link rel="prefetch" href="/note/assets/3.ä¾èµ–æ”¶é›†.html.8c30101c.js" as="script" /><link rel="prefetch" href="/note/assets/4.æ´¾å‘æ›´æ–°.html.643ceb67.js" as="script" /><link rel="prefetch" href="/note/assets/5._nexttick.html.25246fea.js" as="script" /><link rel="prefetch" href="/note/assets/6.æ£€æµ‹æ•°æ®å˜åŒ–.html.707200bf.js" as="script" /><link rel="prefetch" href="/note/assets/7.è®¡ç®—å±æ€§å’Œç›‘å¬å±æ€§.html.86ea6c54.js" as="script" /><link rel="prefetch" href="/note/assets/1.keep-alive.html.181eeecf.js" as="script" /><link rel="prefetch" href="/note/assets/å“åº”å¼.html.56fbaedc.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.123f89ed.js" as="script" /><link rel="prefetch" href="/note/assets/vueæ›´æ–°ç²’åº¦å¦‚ä½•æ§åˆ¶åœ¨ç»„ä»¶çº§åˆ«.html.ae57f022.js" as="script" /><link rel="prefetch" href="/note/assets/index.html.f4f56558.js" as="script" /><link rel="prefetch" href="/note/assets/hashå’Œhistoryä¼˜ç¼ºç‚¹.html.1636f998.js" as="script" /><link rel="prefetch" href="/note/assets/404.html.37c2ace2.js" as="script" /><link rel="prefetch" href="/note/assets/photoswipe.esm.720e8656.js" as="script" />
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/note/" class="brand"><!----><!----><span class="site-name">marxçš„å­¦ä¹ ç¬”è®°</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/note/JS/" class="nav-link" aria-label="JS"><!---->JS<!----></a></div><div class="nav-item hide-in-mobile"><a href="/note/TS/" class="nav-link" aria-label="TS"><!---->TS<!----></a></div><div class="nav-item hide-in-mobile"><a href="/note/webpack/" class="nav-link" aria-label="webpack"><!---->webpack<!----></a></div><div class="nav-item hide-in-mobile"><a href="/note/vite/" class="nav-link" aria-label="vite"><!---->vite<!----></a></div><div class="nav-item hide-in-mobile"><a href="/note/react/" class="nav-link" aria-label="react"><!---->react<!----></a></div><div class="nav-item hide-in-mobile"><a href="/note/redux/" class="nav-link" aria-label="redux"><!---->redux<!----></a></div><div class="nav-item hide-in-mobile"><a href="/note/vue2%E6%BA%90%E7%A0%81/" class="nav-link" aria-label="vue2æºç "><!---->vue2æºç <!----></a></div><div class="nav-item hide-in-mobile"><a href="/note/vue3%E6%BA%90%E7%A0%81/" class="nav-link active" aria-label="vue3æºç "><!---->vue3æºç <!----></a></div><div class="nav-item hide-in-mobile"><a href="/note/vue-router3%E6%BA%90%E7%A0%81/" class="nav-link" aria-label="vue-router3æºç "><!---->vue-router3æºç <!----></a></div><div class="nav-item hide-in-mobile"><a href="/note/%E7%BD%91%E7%BB%9C/" class="nav-link" aria-label="ç½‘ç»œ"><!---->ç½‘ç»œ<!----></a></div><div class="nav-item hide-in-mobile"><a href="/note/%E9%9D%A2%E8%AF%95%E9%A2%98/" class="nav-link" aria-label="é¢è¯•é¢˜"><!---->é¢è¯•é¢˜<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><!----><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/note/vue3%E6%BA%90%E7%A0%81/" class="nav-link sidebar-link sidebar-page" aria-label="é¦–é¡µ"><!---->é¦–é¡µ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/note/vue3%E6%BA%90%E7%A0%81/1.vnode%E5%88%B0dom.html" class="nav-link sidebar-link sidebar-page" aria-label="vnodeåˆ°domï¼ˆç»„ä»¶æ¸²æŸ“ï¼‰"><!---->vnodeåˆ°domï¼ˆç»„ä»¶æ¸²æŸ“ï¼‰<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/note/vue3%E6%BA%90%E7%A0%81/2.diff%E6%B5%81%E7%A8%8B.html" class="nav-link sidebar-link sidebar-page" aria-label="diffæµç¨‹ï¼ˆç»„ä»¶æ›´æ–°ï¼‰"><!---->diffæµç¨‹ï¼ˆç»„ä»¶æ›´æ–°ï¼‰<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/note/vue3%E6%BA%90%E7%A0%81/3.setup.html" class="nav-link sidebar-link sidebar-page" aria-label="setupï¼ˆç»„ä»¶åˆå§‹åŒ–ï¼‰"><!---->setupï¼ˆç»„ä»¶åˆå§‹åŒ–ï¼‰<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="å“åº”å¼"><!---->å“åº”å¼<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#reactive-api" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Reactive API"><!---->Reactive API<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#mutablehandlersé…ç½®" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="mutableHandlersé…ç½®"><!---->mutableHandlersé…ç½®<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#åœ¨getå‡½æ•°ä¸­å®ç°ä¾èµ–æ”¶é›†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="åœ¨getå‡½æ•°ä¸­å®ç°ä¾èµ–æ”¶é›†"><!---->åœ¨getå‡½æ•°ä¸­å®ç°ä¾èµ–æ”¶é›†<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#arrayinstrumentations-å°è£…æ•°ç»„æ–¹æ³•" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="arrayInstrumentations å°è£…æ•°ç»„æ–¹æ³•"><!---->arrayInstrumentations å°è£…æ•°ç»„æ–¹æ³•<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#track-ä¾èµ–æ”¶é›†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="track ä¾èµ–æ”¶é›†"><!---->track ä¾èµ–æ”¶é›†<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#åœ¨setå‡½æ•°ä¸­å®ç°æ´¾å‘æ›´æ–°" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="åœ¨setå‡½æ•°ä¸­å®ç°æ´¾å‘æ›´æ–°"><!---->åœ¨setå‡½æ•°ä¸­å®ç°æ´¾å‘æ›´æ–°<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#å‰¯ä½œç”¨å‡½æ•°" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="å‰¯ä½œç”¨å‡½æ•°"><!---->å‰¯ä½œç”¨å‡½æ•°<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#readonly-api" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Readonly API"><!---->Readonly API<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#ref-api" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Ref API"><!---->Ref API<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#æ€»ç»“" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="æ€»ç»“"><!---->æ€»ç»“<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/note/vue3%E6%BA%90%E7%A0%81/5.%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7.html" class="nav-link sidebar-link sidebar-page" aria-label="è®¡ç®—å±æ€§"><!---->è®¡ç®—å±æ€§<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/note/vue3%E6%BA%90%E7%A0%81/6.%E7%9B%91%E5%90%AC%E5%99%A8.html" class="nav-link sidebar-link sidebar-page" aria-label="ç›‘å¬å™¨"><!---->ç›‘å¬å™¨<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/note/vue3%E6%BA%90%E7%A0%81/7.%E5%BC%82%E6%AD%A5%E9%98%9F%E5%88%97.html" class="nav-link sidebar-link sidebar-page" aria-label="å¼‚æ­¥é˜Ÿåˆ—"><!---->å¼‚æ­¥é˜Ÿåˆ—<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/note/vue3%E6%BA%90%E7%A0%81/8.%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E9%92%A9%E5%AD%90.html" class="nav-link sidebar-link sidebar-page" aria-label="ç”Ÿå‘½å‘¨æœŸé’©å­"><!---->ç”Ÿå‘½å‘¨æœŸé’©å­<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/note/vue3%E6%BA%90%E7%A0%81/9.%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5.html" class="nav-link sidebar-link sidebar-page" aria-label="ä¾èµ–æ³¨å…¥"><!---->ä¾èµ–æ³¨å…¥<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/note/vue3%E6%BA%90%E7%A0%81/100.%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA.html" class="nav-link sidebar-link sidebar-page" aria-label="é¡¹ç›®æ„å»ºç›¸å…³"><!---->é¡¹ç›®æ„å»ºç›¸å…³<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><a href="/note/vue3%E6%BA%90%E7%A0%81/101.%E6%89%8B%E5%86%99%E9%83%A8%E5%88%86/%E5%93%8D%E5%BA%94%E5%BC%8F.html" class="title">æ‰‹å†™éƒ¨åˆ†</a><span class="arrow right"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->å“åº”å¼</h1><div class="page-info"><!----><!----><span class="date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2022-12-07T02:44:14.000Z"></span><!----><!----><span class="reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 19 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT19M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">æ­¤é¡µå†…å®¹</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#reactive-api" class="router-link-active router-link-exact-active toc-link level2">Reactive API</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#mutablehandlersé…ç½®" class="router-link-active router-link-exact-active toc-link level2">mutableHandlersé…ç½®</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#åœ¨getå‡½æ•°ä¸­å®ç°ä¾èµ–æ”¶é›†" class="router-link-active router-link-exact-active toc-link level2">åœ¨getå‡½æ•°ä¸­å®ç°ä¾èµ–æ”¶é›†</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#arrayinstrumentations-å°è£…æ•°ç»„æ–¹æ³•" class="router-link-active router-link-exact-active toc-link level3">arrayInstrumentations å°è£…æ•°ç»„æ–¹æ³•</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#track-ä¾èµ–æ”¶é›†" class="router-link-active router-link-exact-active toc-link level3">track ä¾èµ–æ”¶é›†</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#åœ¨setå‡½æ•°ä¸­å®ç°æ´¾å‘æ›´æ–°" class="router-link-active router-link-exact-active toc-link level2">åœ¨setå‡½æ•°ä¸­å®ç°æ´¾å‘æ›´æ–°</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#å‰¯ä½œç”¨å‡½æ•°" class="router-link-active router-link-exact-active toc-link level2">å‰¯ä½œç”¨å‡½æ•°</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#readonly-api" class="router-link-active router-link-exact-active toc-link level2">Readonly API</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#ref-api" class="router-link-active router-link-exact-active toc-link level2">Ref API</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/note/vue3%E6%BA%90%E7%A0%81/4.%E5%93%8D%E5%BA%94%E5%BC%8F.html#æ€»ç»“" class="router-link-active router-link-exact-active toc-link level2">æ€»ç»“</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="å“åº”å¼" tabindex="-1"><a class="header-anchor" href="#å“åº”å¼" aria-hidden="true">#</a> å“åº”å¼</h1><p>å“åº”å¼æ˜¯vueçš„ä¸€å¤§æ ¸å¿ƒæ€æƒ³ï¼Œåœ¨æ•°æ®æ›´æ–°çš„æ—¶å€™è‡ªåŠ¨æ›´æ–°è§†å›¾ï¼Œå…ˆå›é¡¾ä¸€ä¸‹vue2.xçš„å“åº”å¼æ˜¯å¦‚ä½•å®ç°çš„</p><p><img src="/note/assets/vue2defineProperty.257f068c.png" alt=""></p><p>åœ¨inité˜¶æ®µå¯¹dataé…ç½®è¿›è¡Œåˆå§‹åŒ–ï¼Œå°†dataè½¬åŒ–ä¸ºå¯è§‚å¯Ÿå¯¹è±¡ï¼ˆObserverï¼‰ï¼Œåœ¨å¯è§‚å¯Ÿå¯¹è±¡çš„getterå‡½æ•°ä¸­ä½¿ç”¨depæ”¶é›†ä¾èµ–watcherï¼Œåœ¨setterå‡½æ•°ä¸­é€šçŸ¥depä¸­çš„watcheræ›´æ–°ã€‚ä¹‹åå†mounté˜¶æ®µåˆ›å»ºwatcherçš„æ—¶å€™å¯¹dataä¸­çš„å¯¹è±¡è¿›è¡Œæ‰‹åŠ¨è®¿é—®ï¼Œä»è€Œè§¦å‘ä¾èµ–æ”¶é›†</p><p>å…¶ä¸­depå°±æ˜¯ä¸€ä¸ªä¾èµ–æ”¶é›†å™¨ï¼Œç”¨æ¥æ”¶é›†ä¾èµ–ä¹Ÿå°±æ˜¯ç›‘å¬è€…watcherï¼Œè€Œwatcherå°±æ˜¯ç”¨æ¥é€šçŸ¥æ›´æ–°çš„ï¼Œå®é™…ä¸Šwatcherä¸Šè®°å½•ç€å½“å‰çš„vueå®ä¾‹ï¼Œè§¦å‘æ›´æ–°ä¹Ÿæ˜¯vueå®ä¾‹çš„æ›´æ–°</p><p>å¯è§‚å¯Ÿå¯¹è±¡çš„å†…éƒ¨æ˜¯ä½¿ç”¨ <code>Object.defineProperty</code> å®ç°çš„ï¼Œé€šè¿‡æ•°æ®åŠ«æŒå®ç°æ”¶é›†å’Œæ›´æ–°æ•°æ®æ—¶ä½¿ç”¨depé€šçŸ¥ä¾èµ–watcheræ›´æ–°è§†å›¾ï¼Œ<code>Object.defineProperty</code> ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼Œå› ä¸ºæ˜¯å¯¹è±¡å±æ€§çš„ç›‘å¬ï¼Œæ‰€ä»¥æ— æ³•ç›‘å¬åˆ°å¯¹è±¡çš„å¢åŠ å’Œåˆ é™¤ï¼Œåˆå§‹åŒ–é€’å½’å…¨éƒ¨dataæ•°æ®ä¹Ÿæœ‰ä¸€äº›æ€§èƒ½æå‡çš„ç©ºé—´</p><p>vue3ä¸ºäº†è§£å†³ <code>Object.defineProperty</code> è¿™äº›é—®é¢˜ï¼Œé€‰ç”¨ <code>Proxy</code> é‡å†™äº†å“åº”å¼çš„éƒ¨åˆ†ï¼Œå¹¶å°†å“åº”å¼çš„ä»£ç éƒ½æ”¾åœ¨reactivityåº“ä¸‹</p><h2 id="reactive-api" tabindex="-1"><a class="header-anchor" href="#reactive-api" aria-hidden="true">#</a> Reactive API</h2><p>vue2.xå“åº”å¼çš„å‰ææ˜¯éœ€è¦å°†æ•°æ®å®šä¹‰åœ¨dataä¸­ï¼Œå¦‚æœç›´æ¥å‘vueå®ä¾‹æ·»åŠ å±æ€§æ˜¯ä¸ä¼šæœ‰å“åº”å¼çš„ï¼Œå‰é¢ä¹Ÿè¯´åˆ°å“åº”å¼æ˜¯åœ¨inité˜¶æ®µå¯¹dataè¿›è¡Œçš„å¤„ç†ï¼Œä¹‹æ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡å®ä¾‹è®¿é—®dataçš„æ•°æ®ï¼Œæ˜¯å› ä¸ºvue2.xå°†dataçš„å±æ€§éƒ½ä»£ç†åˆ°äº†vueå®ä¾‹ä¸Š</p><div class="language-vue line-numbers-mode" data-ext="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">test1</span><span class="token operator">:</span> <span class="token string">&quot;test1&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>test2 <span class="token operator">=</span> <span class="token string">&quot;test2&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    
    <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">setTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>test1 <span class="token operator">=</span> <span class="token string">&quot;test111&quot;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>test2 <span class="token operator">=</span> <span class="token string">&quot;test222&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>test2</code> å› ä¸ºç›´æ¥å®šä¹‰åœ¨vueå®ä¾‹ä¸Šï¼Œæ‰€ä»¥åœ¨ <code>setTest</code> å‡½æ•°ä¸­ä¿®æ”¹æ˜¯ä¸ä¼šæœ‰å“åº”å¼çš„ã€‚å“åº”å¼ä¼šç‰ºç‰²æ€§èƒ½ï¼Œå¦‚æœæœ‰äº›æ•°æ®ä¸ºå¸¸é‡ï¼Œå¹¶ä¸å¸Œæœ›æœ‰å“åº”å¼ï¼Œé‚£ä¹ˆå¯ä»¥è¿™ä¹ˆåš</p><p>vue3é€šè¿‡Reactive APIå®ç°å“åº”å¼</p><div class="language-vue line-numbers-mode" data-ext="vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">{</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token string">&#39;test&#39;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token keyword">function</span> <span class="token function">setDataTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>test <span class="token operator">=</span> <span class="token string">&quot;new test&quot;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        setDataTest<span class="token punctuation">,</span>
        data
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>vue3é€šè¿‡ <code>setup</code> å’Œ <code>reactive</code> å‡½æ•°å®ç°äº†å’Œvue2.xåŒæ ·çš„æ•ˆæœã€‚æˆ‘ä»¬ä¹‹å‰åˆ†æè¿‡setupçš„æµç¨‹ï¼Œåœ¨mounté˜¶æ®µè®¾ç½®ç»„ä»¶å®ä¾‹çš„æ—¶å€™ä¼šè§¦å‘setupå‡½æ•°ï¼Œå¹¶å°†è¿”å›å€¼æŒ‚è½½åˆ°ç»„ä»¶å®ä¾‹ä¸Šï¼Œå› æ­¤å“åº”å¼çš„åŠŸèƒ½æ˜¯ç”±reactiveå‡½æ•°å®Œæˆçš„ï¼Œæˆ‘ä»¬ç›´æ¥åˆ†æreactiveå‡½æ•°æºç </p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// ä»£ç†ç¼“å­˜</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> reactiveMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap<span class="token operator">&lt;</span>Target<span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span>target<span class="token operator">:</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// å¦‚æœæ˜¯åªè¯»åˆ™ç›´æ¥è¿”å›</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isReadonly</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>
  <span class="token comment">// åˆ›å»ºå“åº”å¼å¯¹è±¡</span>
  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>
    target<span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    mutableHandlers<span class="token punctuation">,</span>
    mutableCollectionHandlers<span class="token punctuation">,</span>
    reactiveMap
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>
  target<span class="token operator">:</span> Target<span class="token punctuation">,</span>
  isReadonly<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  baseHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  collectionHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  proxyMap<span class="token operator">:</span> WeakMap<span class="token operator">&lt;</span>Target<span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// reactiveæ–¹æ³•å¿…é¡»æ¥å—ä¸€ä¸ªå¯¹è±¡æˆ–æ•°ç»„ç±»å‹å³ typeof target === &#39;object&#39;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    target<span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">RAW</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token punctuation">(</span>isReadonly <span class="token operator">&amp;&amp;</span> target<span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœå·²ç»æ˜¯ä¸€ä¸ªå“åº”å¼å¯¹è±¡ç›´æ¥è¿”å›ï¼Œé™¤äº†è¯¥å“åº”å¼å¯¹è±¡æ˜¯åªè¯»çš„ï¼Œå› ä¸ºåªè¯»éœ€è¦å¯¹getteråšå¤„ç†</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>

  <span class="token comment">// åˆ¤æ–­ä¼ å…¥å¯¹è±¡æ˜¯å¦åœ¨ä»£ç†ç¼“å­˜ä¸­ï¼Œå¦‚æœå­˜åœ¨ç›´æ¥è¿”å›  </span>
  <span class="token keyword">const</span> existingProxy <span class="token operator">=</span> proxyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>existingProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> existingProxy
  <span class="token punctuation">}</span>
  <span class="token comment">// è·å–ä¼ å…¥å¯¹è±¡ç±»å‹ï¼ŒINVALIDè¡¨ç¤ºæ•°æ®ä¸å¯æ‹“å±•ï¼ˆä¸èƒ½æ·»åŠ æ–°å±æ€§ï¼‰ï¼ŒCOLLECTIONè¡¨ç¤ºæ•°æ®ä¸ºMapã€Setç±»å‹</span>
  <span class="token keyword">const</span> targetType <span class="token operator">=</span> <span class="token function">getTargetType</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>targetType <span class="token operator">===</span> TargetType<span class="token punctuation">.</span><span class="token constant">INVALID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿™é‡Œå¦‚æœä¼ å…¥æ•°æ®æ˜¯ä¸å¯æ‹“å±•çš„ç±»å‹åˆ™ç›´æ¥è¿”å›</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>
  <span class="token comment">// åˆ›å»ºä¼ å…¥å¯¹è±¡çš„ä»£ç†ï¼Œæ ¹æ®ä¼ å…¥å¯¹è±¡çš„ç±»å‹é€‰ç”¨ä¸åŒçš„é…ç½®</span>
  <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>
    target<span class="token punctuation">,</span>
    targetType <span class="token operator">===</span> TargetType<span class="token punctuation">.</span><span class="token constant">COLLECTION</span> <span class="token operator">?</span> collectionHandlers <span class="token operator">:</span> baseHandlers
  <span class="token punctuation">)</span>
  <span class="token comment">// è®°å…¥ç¼“å­˜</span>
  proxyMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span>
  <span class="token keyword">return</span> proxy
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>reactive</code> å‡½æ•°æ˜¯å¯¹åªè¯»æ•°æ®è¿›è¡Œäº†åˆ¤æ–­ï¼Œå“åº”å¼çš„æ ¸å¿ƒæ˜¯ <code>createReactiveObject</code> å‡½æ•°å¤„ç†çš„ï¼Œè¯¥å‡½æ•°æœ‰å‡ ä¸ªé‡è¦é€»è¾‘</p><ul><li>åˆ¤æ–­ä¸€äº›ä¸éœ€è¦è¿›è¡Œä»£ç†çš„åˆ†æ”¯æƒ…å†µï¼Œç›´æ¥è¿”å›ä¼ å…¥æ•°æ®ã€‚æˆ–æ˜¯å‘½ä¸­ç¼“å­˜ï¼Œè¿”å›ç¼“å­˜çš„æ•°æ®ä»£ç†</li><li>åˆ›å»ºæ•°æ®çš„ä»£ç†ï¼Œæ ¹æ®æ•°æ®ç±»å‹é€‰ç”¨é…ç½®</li><li>è®°å…¥ç¼“å­˜</li></ul><p>å½“ä¼ å…¥æ•°æ®ç±»å‹æ˜¯(Weak)Mapæˆ–(Weak)Setæ—¶ä¼šä½¿ç”¨ <code>collectionHandlers</code> é…ç½®ï¼Œæˆ‘ä»¬æš‚æ—¶ä¸è€ƒè™‘è¯¥æƒ…å†µï¼Œå¦‚æœä¼ å…¥ä¸€ä¸ªæ™®é€šçš„æ•°ç»„æˆ–å¯¹è±¡åˆ™ä½¿ç”¨ <code>baseHandlers</code> é…ç½®ï¼Œä¹Ÿå°±æ˜¯ <code>mutableHandlers</code>ï¼Œæ¥ä¸‹æ¥å°±åˆ†æå…¶é…ç½®</p><h2 id="mutablehandlersé…ç½®" tabindex="-1"><a class="header-anchor" href="#mutablehandlersé…ç½®" aria-hidden="true">#</a> mutableHandlersé…ç½®</h2><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> mutableHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>object<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  get<span class="token punctuation">,</span>
  set<span class="token punctuation">,</span>
  deleteProperty<span class="token punctuation">,</span>
  has<span class="token punctuation">,</span>
  ownKeys
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>mutableHandlers</code> é…ç½®äº†å¾ˆå¤šå±æ€§ï¼Œå¯¹è·å–ï¼ˆgetï¼‰ã€è®¾ç½®ï¼ˆsetï¼‰ã€åˆ é™¤ï¼ˆdeletePropertyï¼‰ã€inæ“ä½œç¬¦ï¼ˆhasï¼‰ã€Object.getOwnPropertyNamesï¼ˆownKeysï¼‰è¡Œä¸ºè¿›è¡Œäº†ä»£ç†ï¼Œåœ¨è§¦å‘è¿™äº›è¡Œä¸ºæ—¶æ— éåšäº†æ”¶é›†ä¾èµ–ã€æ´¾å‘æ›´æ–°ã€æ¸…é™¤ä¾èµ–è¿™ä¸‰ä¸ªäº‹çš„å…¶ä¸­ä¸€ç§ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹åˆ†ægetã€set</p><h2 id="åœ¨getå‡½æ•°ä¸­å®ç°ä¾èµ–æ”¶é›†" tabindex="-1"><a class="header-anchor" href="#åœ¨getå‡½æ•°ä¸­å®ç°ä¾èµ–æ”¶é›†" aria-hidden="true">#</a> åœ¨getå‡½æ•°ä¸­å®ç°ä¾èµ–æ”¶é›†</h2><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> get <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">createGetter</span><span class="token punctuation">(</span>isReadonly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> shallow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token operator">:</span> Target<span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span> receiver<span class="token operator">:</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¤„ç†è¯¥æ•°æ®çš„æè¿°å±æ€§</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ˜¯å¦æ˜¯å“åº”å¼</span>
      <span class="token keyword">return</span> <span class="token operator">!</span>isReadonly
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_READONLY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ˜¯å¦æ˜¯åªè¯»ï¼Œè¿™é‡Œçš„åªè¯»å’Œå“åº”å¼æ˜¯äº’æ–¥çš„</span>
      <span class="token keyword">return</span> isReadonly
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_SHALLOW</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ˜¯å¦æ˜¯æµ…å“åº”å¼</span>
      <span class="token keyword">return</span> shallow
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
      key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">RAW</span> <span class="token operator">&amp;&amp;</span>
      receiver <span class="token operator">===</span>
        <span class="token punctuation">(</span>isReadonly
          <span class="token operator">?</span> shallow
            <span class="token operator">?</span> shallowReadonlyMap
            <span class="token operator">:</span> readonlyMap
          <span class="token operator">:</span> shallow
          <span class="token operator">?</span> shallowReactiveMap
          <span class="token operator">:</span> reactiveMap
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ˜¯å¦æ˜¯åŸç”Ÿæ•°æ®ï¼ˆå°±æ˜¯è¢«ä»£ç†çš„æ•°æ®ï¼‰</span>
      <span class="token keyword">return</span> target
    <span class="token punctuation">}</span>

    <span class="token comment">// åˆ¤æ–­æ˜¯å¦ä¸ºæ•°ç»„</span>
    <span class="token keyword">const</span> targetIsArray <span class="token operator">=</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isReadonly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>targetIsArray <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>arrayInstrumentations<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœè®¿é—®çš„å±æ€§æ˜¯éåªè¯»ä¸”æ˜¯éƒ¨åˆ†æ•°ç»„æ–¹æ³•æ—¶ç›´æ¥è¿”å›è¯¥æ–¹æ³•</span>
        <span class="token comment">// &#39;includes&#39;, &#39;indexOf&#39;, &#39;lastIndexOf&#39;, &#39;push&#39;, &#39;pop&#39;, &#39;shift&#39;, &#39;unshift&#39;, &#39;splice&#39;</span>
        <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arrayInstrumentations<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// å¤„ç†æ•°ç»„æ–¹æ³•åæ”¹å†™hasOwnPropertyæ–¹æ³•ï¼Œå› ä¸ºhasOwnå†…éƒ¨æ˜¯ä½¿ç”¨hasOwnPropertyæ–¹æ³•å®ç°</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;hasOwnProperty&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¯¥æ•°æ®æ˜¯éåªè¯»ä¸”è®¿é—®hasOwnPropertyæ–¹æ³•æ—¶è¿”å›å°è£…åçš„è¯¥æ–¹æ³•</span>
        <span class="token keyword">return</span> hasOwnProperty
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è·å–è®¿é—®å±æ€§çš„å€¼</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSymbol</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">?</span> builtInSymbols<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">isNonTrackableKeys</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœè®¿é—®çš„æ˜¯å†…ç½®çš„symbol key æˆ–æ˜¯ __proto__ã€__v_isRefã€__isVueå±æ€§åˆ™ç›´æ¥è¿”å›</span>
      <span class="token keyword">return</span> res
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isReadonly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœä¸æ˜¯åªè¯»å±æ€§åˆ™è¿›è¡Œä¾èµ–æ”¶é›†</span>
      <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>shallow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœæ˜¯æµ…å“åº”å¼åœ¨æ”¶é›†ä¾èµ–åç›´æ¥è¿”å›</span>
      <span class="token keyword">return</span> res
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœè®¿é—®çš„å€¼æ˜¯refæœ‰ä¸¤ç§å¤„ç†æƒ…å†µï¼Œå¦‚æœå€¼æ˜¯æ•°ç»„è¿”å›å€¼ï¼Œå¦‚æœå€¼éæ•°ç»„è¿”å›</span>
      <span class="token keyword">return</span> targetIsArray <span class="token operator">&amp;&amp;</span> <span class="token function">isIntegerKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">?</span> res <span class="token operator">:</span> res<span class="token punctuation">.</span>value
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœæ˜¯å¯¹è±¡æœ‰ä¸¤ä¸ªå¤„ç†æƒ…å†µï¼Œå¦‚æœæ˜¯åªè¯»åˆ™èµ°åªè¯»é€»è¾‘ï¼Œå¦åˆ™é€’å½’è®¿é—®å±æ€§çš„å€¼è¿›è¡Œä¾èµ–æ”¶é›†</span>
      <span class="token keyword">return</span> isReadonly <span class="token operator">?</span> <span class="token keyword">readonly</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> res
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>get</code> æ˜¯é€šè¿‡ <code>createGetter</code> å‡½æ•°è·å¾—ï¼Œå› ä¸ºreadonlyã€shallowReactiveç­‰APIä¹Ÿéœ€è¦getå‡½æ•°</p><p><code>get</code> å‡½æ•°çš„å‡ ä¸ªä¸»è¦é€»è¾‘</p><ul><li>å¤„ç†å†…ç½®çš„ä¸€äº›å¯¹æ•°æ®æè¿°çš„å±æ€§</li><li>å¤„ç†æ•°ç»„æ–¹æ³•ç›´æ¥è¿”å›ï¼Œä¹‹åé‡å†™hasOwnPropertyæ–¹æ³•</li><li>æ”¶é›†ä¾èµ–</li><li>åˆ¤æ–­æ˜¯å¦æ˜¯æµ…å“åº”æˆ–refï¼Œç›´æ¥è¿”å›å¯¹åº”å€¼ï¼Œå…¶ä¸­refç»“æ„è¿”å›</li><li>å¦‚æœæ˜¯å¯¹è±¡ã€æ•°ç»„ã€mapã€seté€’å½’å­å±æ€§</li></ul><p>è‡³æ­¤æ•´ä¸ªgetå‡½æ•°å°±åˆ†æå®Œäº†ï¼Œæœ¬è´¨å°±æ˜¯é€’å½’å­å±æ€§è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œå½“ä»£ç†æ•°æ®è¢«è®¿é—®çš„æ—¶å€™æ‰ä¼šé€’å½’æ”¶é›†å­å±æ€§ä¾èµ–ï¼Œè¿™é‡Œå¯¹æ¯”vue2.xçš„åœ¨åˆå§‹åŒ–ä¸­é€’å½’æ‰€æœ‰å±æ€§æ”¶é›†ä¾èµ–çš„æ€§èƒ½æœ‰æ‰€æå‡ã€‚å…¶ä¸­ä¸€äº›æ•°ç»„æ–¹æ³•æ”¾ç½®åœ¨ <code>arrayInstrumentations</code> ä¸­è¿›è¡Œå¤„ç†ï¼Œè€Œæ”¶é›†ä¾èµ–åœ¨å‡½æ•° <code>track</code> ä¸­ï¼Œæˆ‘ä»¬ä¾æ¬¡åˆ†æ</p><h3 id="arrayinstrumentations-å°è£…æ•°ç»„æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#arrayinstrumentations-å°è£…æ•°ç»„æ–¹æ³•" aria-hidden="true">#</a> arrayInstrumentations å°è£…æ•°ç»„æ–¹æ³•</h3><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> arrayInstrumentations <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createArrayInstrumentations</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">createArrayInstrumentations</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> instrumentations<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">Function</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  
  <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;includes&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;indexOf&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;lastIndexOf&#39;</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>key <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¯¹&#39;includes&#39;, &#39;indexOf&#39;, &#39;lastIndexOf&#39;ä¸‰ä¸ªæ–¹æ³•è¿›è¡Œå°è£…</span>
    instrumentations<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è·å–ä»£ç†å‰çš„æ•°æ®</span>
      <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">any</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// éå†æ•°ç»„æ”¶é›†ä¾èµ–</span>
        <span class="token function">track</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// è°ƒç”¨æ•°ç»„åŸç”Ÿæ–¹æ³•å°†å‚æ•°é€ä¼ è·å¾—ç»“æœ</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> arr<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> res <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å› ä¸ºè°ƒç”¨æ•°ç»„æ–¹æ³•ä¼ å…¥çš„å¯èƒ½æ˜¯ä¸€ä¸ªå€¼çš„ä»£ç†ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°è¯¥å€¼åˆ™ä½¿ç”¨toRawè·å–ä»£ç†å‰çš„å€¼é‡æ–°è°ƒç”¨æ–¹æ³•</span>
        <span class="token keyword">return</span> arr<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>toRaw<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  <span class="token comment">// å¯¹&#39;push&#39;, &#39;pop&#39;, &#39;shift&#39;, &#39;unshift&#39;, &#39;splice&#39;æ–¹æ³•è¿›è¡Œå°è£…ï¼Œåœ¨è°ƒç”¨æœŸé—´æš‚åœè·Ÿè¸ª</span>
  <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;push&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;pop&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;shift&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;unshift&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;splice&#39;</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>key <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    instrumentations<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">pauseTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
      <span class="token function">resetTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> res
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> instrumentations
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>arrayInstrumentations</code> æ˜¯è°ƒç”¨ <code>createArrayInstrumentations</code> å‡½æ•°è¿”å›çš„ç»“æœï¼Œå‡½æ•°å†…éƒ¨å¯¹ä¸€äº›æ•°ç»„æ–¹æ³•è¿›è¡Œå°è£…ï¼Œå¦‚æœä¿®æ”¹äº†æ•°ç»„ä¸­æŸä¸ªå…ƒç´ ï¼Œincludesã€indexOfã€lastIndexOfæ–¹æ³•çš„ç»“æœå¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™é‡Œéœ€è¦å¯¹æ•°ç»„æ¯ä¸€é¡¹è¿›è¡Œä¾èµ–æ”¶é›†ã€‚åé¢çš„pushç­‰æ–¹æ³•é‡å†™æ˜¯ä¸ºäº†é˜²æ­¢ä¿®æ”¹æ•°ç»„é•¿åº¦äº§ç”Ÿçš„é—®é¢˜ï¼Œè¿™é‡Œä¸ç ”ç©¶</p><h3 id="track-ä¾èµ–æ”¶é›†" tabindex="-1"><a class="header-anchor" href="#track-ä¾èµ–æ”¶é›†" aria-hidden="true">#</a> track ä¾èµ–æ”¶é›†</h3><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// æ˜¯å¦è¿½è¸ªä¾èµ–</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> shouldTrack <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token comment">// å½“å‰å‰¯ä½œç”¨å‡½æ•°</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> activeEffect<span class="token operator">:</span> ReactiveEffect <span class="token operator">|</span> <span class="token keyword">undefined</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token operator">:</span> object<span class="token punctuation">,</span> type<span class="token operator">:</span> TrackOpTypes<span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrack <span class="token operator">&amp;&amp;</span> activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä»targetMapè¡¨ä¸­å–å‡ºä¾èµ–æ”¶é›†å™¨è¡¨depsMapï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ª</span>
    <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è·å–æ”¶é›†å™¨è¡¨depsMapä¸­å¯¹åº”keyçš„æ”¶é›†å™¨ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ª</span>
    <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>dep <span class="token operator">=</span> <span class="token function">createDep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">trackEffects</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trackEffects</span><span class="token punctuation">(</span>
  dep<span class="token operator">:</span> Dep
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>activeEffect<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ”¶é›†å™¨ä¸­ä¸å­˜åœ¨å½“å‰å‰¯ä½œç”¨åæ·»åŠ è¯¥å‰¯ä½œç”¨</span>
    dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token operator">!</span><span class="token punctuation">)</span>
    <span class="token comment">// å‰¯ä½œç”¨ä¹Ÿè®°å½•ä¾èµ–æ”¶é›†å™¨</span>
    activeEffect<span class="token operator">!</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>shouldTrack</code> æ˜¯æŸäº›åœºæ™¯ä¸‹ä¸è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œ<code>activeEffect</code> å°±æ˜¯å½“å‰å‰¯ä½œç”¨å‡½æ•°ï¼Œè¿™é‡Œå»ºç«‹äº†ä¸€ä¸ª æ•°æ®ï¼ˆtargetï¼‰=&gt; æ•°æ®å±æ€§ï¼ˆkeyï¼‰ =&gt; æ”¶é›†å™¨ï¼ˆdepï¼‰çš„ä¾èµ–å…³ç³»ï¼Œä¹‹åè°ƒç”¨ <code>trackEffects</code> å‡½æ•°æ·»åŠ ä¾èµ–ï¼Œå°†å½“å‰å‰¯ä½œç”¨æ·»åŠ è‡³æ”¶é›†å™¨ä¸­ï¼Œå¹¶ä¸”å½“å‰å‰¯ä½œç”¨ä¹Ÿæ·»åŠ äº†æ”¶é›†å™¨ï¼Œæ­¤æ—¶targetMapçš„ç»“æ„å¦‚ä¸‹</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token punctuation">{</span>
  target<span class="token operator">:</span> <span class="token punctuation">{</span>
    key<span class="token operator">:</span> <span class="token punctuation">[</span> 
      effect <span class="token keyword">as</span> ReactiveEffect
    <span class="token punctuation">]</span> <span class="token keyword">as</span> dep
  <span class="token punctuation">}</span> <span class="token keyword">as</span> depsMap
<span class="token punctuation">}</span> <span class="token keyword">as</span> targetMap
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="åœ¨setå‡½æ•°ä¸­å®ç°æ´¾å‘æ›´æ–°" tabindex="-1"><a class="header-anchor" href="#åœ¨setå‡½æ•°ä¸­å®ç°æ´¾å‘æ›´æ–°" aria-hidden="true">#</a> åœ¨setå‡½æ•°ä¸­å®ç°æ´¾å‘æ›´æ–°</h2><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> set <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">createSetter</span><span class="token punctuation">(</span>shallow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">set</span><span class="token punctuation">(</span>
    target<span class="token operator">:</span> object<span class="token punctuation">,</span>
    key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span>
    value<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
    receiver<span class="token operator">:</span> object
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
    <span class="token comment">// å–å‡ºæ—§å€¼</span>
    <span class="token keyword">let</span> oldValue <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isReadonly</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isRef</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isRef</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å½“æ—§å€¼æ˜¯åªè¯»ä¸”æ˜¯refï¼Œå¹¶ä¸”æ–°å€¼ä¸æ˜¯refä¸èƒ½èµ‹å€¼</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shallow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// éæµ…ä»£ç†</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isShallow</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isReadonly</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ–°å€¼éæµ…ä»£ç†ä¸”éåªè¯»ï¼Œå–å‡ºæ–°æ—§å€¼ä»£ç†å‰çš„åŸå€¼</span>
        oldValue <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span>
        value <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isRef</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isRef</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä»£ç†æ•°æ®ä¸ºéæ•°ç»„ï¼Œä¸”æ—§å€¼æ˜¯refï¼Œä¸”æ–°å€¼ä¸æ˜¯refï¼Œå°†æ–°å€¼èµ‹å€¼æ—§å€¼</span>
        oldValue<span class="token punctuation">.</span>value <span class="token operator">=</span> value
        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// in shallow mode, objects are set as-is regardless of reactive or not</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åˆ¤æ–­è¿™ä¸ªkeyæ˜¯å¦å­˜åœ¨ï¼Œè¿™é‡Œåˆ†targetæ˜¯æ•°ç»„æˆ–å¯¹è±¡ä¸¤ç§æƒ…å†µ</span>
    <span class="token keyword">const</span> hadKey <span class="token operator">=</span>
      <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isIntegerKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token operator">?</span> <span class="token function">Number</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&lt;</span> target<span class="token punctuation">.</span>length
        <span class="token operator">:</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token comment">// è®¾ç½®æ•°æ®å±æ€§</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">===</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// receiveræ˜¯æœ€åˆè¢«è°ƒç”¨çš„å¯¹è±¡ï¼Œå¦‚æœæ•°æ®åŸå‹é“¾ä¸Šæœ‰ä¸€ä¸ªproxyï¼Œé‚£ä¹ˆæ•°æ®åœ¨èµ‹å€¼æ—¶è¯¥proxyä¹Ÿä¼šè§¦å‘set</span>
      <span class="token comment">// è¿™é‡Œæ˜¯è¿‡æ»¤æ‰æ•°æ®åŸå‹é“¾ä¸Šçš„proxy</span>

      <span class="token comment">// æ ¹æ®keyæ˜¯å¦å­˜åœ¨è°ƒç”¨æ´¾å‘æ›´æ–°å‡½æ•°ä¼ å…¥ä¸åŒå‚æ•°</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">ADD</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasChanged</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>set</code> å‡½æ•°ä¸»è¦æ˜¯å¤„ç†èµ‹å€¼ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªé‡è¦é€»è¾‘</p><ul><li>åˆ¤æ–­ä¸èƒ½èµ‹å€¼çš„æƒ…å†µã€‚ä¹‹åæ ‡å‡†åŒ–æ–°æ—§å€¼åè¿›è¡Œèµ‹å€¼</li><li>æ´¾å‘æ›´æ–°é€»è¾‘ï¼Œæ ¹æ®keyæ˜¯å¦å­˜åœ¨èµ°ä¸åŒé€»è¾‘çš„æ´¾å‘æ›´æ–°</li></ul><p>æ´¾å‘æ›´æ–°çš„é€»è¾‘åœ¨ <code>trigger</code> å‡½æ•°ä¸­</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span>
  target<span class="token operator">:</span> object<span class="token punctuation">,</span>
  type<span class="token operator">:</span> TriggerOpTypes<span class="token punctuation">,</span>
  key<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  newValue<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  oldValue<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  oldTarget<span class="token operator">?</span><span class="token operator">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">unknown</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">&gt;</span> <span class="token operator">|</span> Set<span class="token operator">&lt;</span><span class="token builtin">unknown</span><span class="token operator">&gt;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// åœ¨getä¸­å·²ç»å°†æ•°æ®ç¼“å­˜åœ¨targetMapä¸Šï¼Œè¿™é‡Œå°†å¯¹åº”çš„æ”¶é›†å™¨mapå–å‡ºæ¥</span>
  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ²¡æœ‰ä¾èµ–ï¼Œç»“æŸ</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// éœ€è¦æ›´æ–°çš„ä¾èµ–é˜Ÿåˆ—</span>
  <span class="token keyword">let</span> deps<span class="token operator">:</span> <span class="token punctuation">(</span>Dep <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">CLEAR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ¸…é™¤æ”¶é›†ï¼Œå°†æ‰€æœ‰ä¾èµ–æ”¾å…¥æ›´æ–°é˜Ÿåˆ—</span>
    deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>depsMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;length&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœé€šè¿‡ä¸‹æ ‡ä¿®æ”¹æ•°ç»„ç±»å‹çš„æ•°æ®</span>
    <span class="token keyword">const</span> newLength <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span>
    <span class="token comment">// å°†è®¾ç½®ä¸‹æ ‡ä¹‹åæ‰€æœ‰æ•°æ®çš„ä¾èµ–æ”¾å…¥æ›´æ–°é˜Ÿåˆ—ï¼Œè¿˜æœ‰length</span>
    <span class="token comment">// ä¾‹å¦‚ï¼š[1, 2, æ›´æ–°ä¸‹æ ‡æ”¾å…¥æ›´æ–°é˜Ÿåˆ—, åç»­çš„æ•°æ®æ”¾å…¥æ›´æ–°é˜Ÿåˆ—]</span>
    depsMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;length&#39;</span> <span class="token operator">||</span> key <span class="token operator">&gt;=</span> newLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// type åªæœ‰è¿™ä¸‰ç§æƒ…å†µ SET | ADD | DELETE</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœkeyæœ‰å€¼ï¼Œå–å‡ºkeyå¯¹åº”çš„ä¾èµ–[effect, effect, ...]</span>
      deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// å°†depsé˜Ÿåˆ—æ‹å¹³</span>
  <span class="token keyword">const</span> effects<span class="token operator">:</span> ReactiveEffect<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> dep <span class="token keyword">of</span> deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      effects<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>dep<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æ´¾å‘æ›´æ–°</span>
  <span class="token function">triggerEffects</span><span class="token punctuation">(</span><span class="token function">createDep</span><span class="token punctuation">(</span>effects<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>trigger</code> å‡½æ•°çš„ä¸»è¦å¤„ç†å‰¯ä½œç”¨å‡½æ•°ï¼Œæœ€ç»ˆç›®çš„å°†å‰¯ä½œç”¨å‡½æ•°æ”¶é›†åˆ°ä¸€ä¸ªåˆ—è¡¨ä¸­ç­‰å¾…æ‰§è¡Œ</p><ul><li>å–å‡ºæ•°æ®å¯¹åº”çš„ä¾èµ–åœ°å›¾ï¼ˆkey =&gt; effectï¼‰ï¼Œå¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„depsMapåˆ™è®¤ä¸ºæ²¡æœ‰ä¾èµ–ç›´æ¥ç»“æŸ</li><li>æ ¹æ®æ•°æ®çš„ç±»å‹å°†keyå‘½ä¸­çš„ä¾èµ–éƒ½æ”¶é›†åˆ°æ›´æ–°é˜Ÿåˆ—ä¸­</li><li>è°ƒç”¨ <code>triggerEffects</code> å‡½æ•°æ‰§è¡Œé˜Ÿåˆ—</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">triggerEffects</span><span class="token punctuation">(</span>
  dep<span class="token operator">:</span> Dep <span class="token operator">|</span> ReactiveEffect<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  debuggerEventExtraInfo<span class="token operator">?</span><span class="token operator">:</span> DebuggerEventExtraInfo
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// spread into array for stabilization</span>
  <span class="token keyword">const</span> effects <span class="token operator">=</span> <span class="token function">isArray</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span> <span class="token operator">?</span> dep <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>dep<span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> effect <span class="token keyword">of</span> effects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">triggerEffect</span><span class="token punctuation">(</span>effect<span class="token punctuation">,</span> debuggerEventExtraInfo<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">triggerEffect</span><span class="token punctuation">(</span>
  effect<span class="token operator">:</span> ReactiveEffect<span class="token punctuation">,</span>
  debuggerEventExtraInfo<span class="token operator">?</span><span class="token operator">:</span> DebuggerEventExtraInfo
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> activeEffect <span class="token operator">||</span> effect<span class="token punctuation">.</span>allowRecurse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€ç»ˆéå†æ›´æ–°é˜Ÿåˆ—ï¼Œè°ƒç”¨æ¯ä¸ªå‰¯ä½œç”¨å‡½æ•°çš„ <code>run</code> æ–¹æ³•å®ç°æ›´æ–°</p><h2 id="å‰¯ä½œç”¨å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#å‰¯ä½œç”¨å‡½æ•°" aria-hidden="true">#</a> å‰¯ä½œç”¨å‡½æ•°</h2><p><code>patch</code> å‡½æ•°çš„ç»„ä»¶æŒ‚è½½æµç¨‹ä¸­è®¾ç½®äº†å‰¯ä½œç”¨å‡½æ•°ï¼Œåœ¨ <code>setupRenderEffect</code> å‡½æ•°ä¸­</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> setupRenderEffect<span class="token operator">:</span> <span class="token function-variable function">SetupRenderEffectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
    instance<span class="token punctuation">,</span>
    initialVNode<span class="token punctuation">,</span>
    container<span class="token punctuation">,</span>
    anchor<span class="token punctuation">,</span>
    parentSuspense<span class="token punctuation">,</span>
    isSVG<span class="token punctuation">,</span>
    optimized
  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">componentUpdateFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å‰¯ä½œç”¨å‡½æ•°</span>
    <span class="token keyword">const</span> effect <span class="token operator">=</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveEffect</span><span class="token punctuation">(</span>
      componentUpdateFn<span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">queueJob</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">,</span>
      instance<span class="token punctuation">.</span>scope <span class="token comment">// track it in component&#39;s effect scope</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> update<span class="token operator">:</span> SchedulerJob <span class="token operator">=</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯è§å‰¯ä½œç”¨å‡½æ•°å°±æ˜¯ <code>ReactiveEffect</code> ç±»çš„å®ä¾‹ï¼Œè¯¥å®ä¾‹ä¸­æœ‰ä¸€ä¸ªrunæ–¹æ³•</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ReactiveEffect<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>

  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> parent<span class="token operator">:</span> ReactiveEffect <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> activeEffect
    <span class="token keyword">let</span> lastShouldTrack <span class="token operator">=</span> shouldTrack
    <span class="token keyword">while</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>parent
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// ç¼“å­˜ä¹‹å‰çš„å‰¯ä½œç”¨å®ä¾‹</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> activeEffect
      <span class="token comment">// ç¼“å­˜å½“å‰å‰¯ä½œç”¨å®ä¾‹</span>
      activeEffect <span class="token operator">=</span> <span class="token keyword">this</span>
      shouldTrack <span class="token operator">=</span> <span class="token boolean">true</span>

      <span class="token comment">// è®°å½•é€’å½’æ·±åº¦</span>
      trackOpBit <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">++</span>effectTrackDepth

      <span class="token comment">// åœ¨æ¸²æŸ“æ›´æ–°å‰éœ€è¦å¯¹æ—§çš„ä¾èµ–åšå¤„ç†ï¼Œä¾‹å¦‚ï¼šæ—§è§†å›¾ä¸­å¼•ç”¨æ•°æ®aï¼Œæ–°è§†å›¾ä¸­å¼•ç”¨çš„æ•°æ®aå˜ä¸ºbï¼Œé‚£ä¹ˆéœ€è¦åˆ é™¤açš„ä¾èµ–ï¼Œé‡æ–°æ·»åŠ bçš„ä¾èµ–ï¼Œé˜²æ­¢æ•°æ®aæ›´æ–°åäº§ç”Ÿé¢å¤–çš„æ¸²æŸ“å¼€é”€</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTrackDepth <span class="token operator">&lt;=</span> maxMarkerBits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœç»„ä»¶åµŒå¥—å±‚æ•°åµŒå¥—å°‘äº30å±‚ï¼Œè®¾ç½®depsæ¯ä¸ªdep.wä¸ºå·²æ”¶é›†</span>
        <span class="token function">initDepMarkers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ¸…é™¤è¯¥å‰¯ä½œç”¨ä¸­çš„ä¾èµ–ï¼ˆdepï¼‰</span>
        <span class="token function">cleanupEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ï¼Œå¦‚æœç»„ä»¶ä¸­åµŒå¥—ç»„ä»¶</span>
      <span class="token comment">// å¦‚æœç»„ä»¶åµŒå¥—æƒ…å†µåˆ™ä¼šå†æ¬¡å‡ºå‘runæ–¹æ³•è¿›è¡Œé€’å½’</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTrackDepth <span class="token operator">&lt;=</span> maxMarkerBits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆ¤æ–­å½“å‰å‰¯ä½œç”¨çš„depä¸­çš„ä¾èµ–å¦‚æœå·²ç»æ”¶é›†ä½†æ˜¯æ–°ä¾èµ–æ²¡æœ‰åˆ™è¿›è¡Œåˆ é™¤</span>
        <span class="token function">finalizeDepMarkers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// é€’å½’å®Œæˆå›åˆ°ä¸Šçº§</span>
      trackOpBit <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">--</span>effectTrackDepth

      <span class="token comment">// é€’å½’å®Œæˆå°†çŠ¶æ€å›é€€åˆ°ä¸Šä¸€æ¬¡é€’å½’çš„çŠ¶æ€</span>
      activeEffect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent
      shouldTrack <span class="token operator">=</span> lastShouldTrack
      <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">undefined</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deferStop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>run</code> æ–¹æ³•ä¼šè°ƒç”¨çœŸæ­£çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œä½†æ˜¯åœ¨è¿™ä¹‹å‰éœ€è¦å¤„ç†ä¸€äº›ä¾èµ–æƒ…å†µ</p><ul><li>è®°å½•å½“å‰å‰¯ä½œç”¨å®ä¾‹</li><li>æ¸…ç©ºä¾èµ–ï¼ˆå½“è§†å›¾æ›´æ–°ä¾èµ–å˜æ›´æ—¶ï¼Œå¦‚æœä¸æ¸…ç©ºä¾èµ–å¯èƒ½ä¼šé€ æˆé¢å¤–çš„æ¸²æŸ“å¼€é”€ï¼‰</li><li>è°ƒç”¨å‰¯ä½œç”¨å‡½æ•°ï¼ˆå…¶ä¸­ä¼šè§¦å‘renderä»è€Œè§¦å‘å“åº”å¼æ•°æ®çš„getterä»è€Œæ”¶é›†ä¾èµ–ï¼‰èµ°patchæµç¨‹</li><li>å½“å‰¯ä½œç”¨å‡½æ•°è°ƒç”¨å®Œæ¯•å°†å½“å‰çš„å‰¯ä½œç”¨å‡½æ•°æ¢å¤ä¹‹å‰çš„çŠ¶æ€</li></ul><p>å‰¯ä½œç”¨å‡½æ•°åœ¨ç»„ä»¶åµŒå¥—çš„æƒ…å†µä¸‹ä¼šé€’å½’è°ƒç”¨ <code>run</code> æ–¹æ³•ï¼Œå› æ­¤éœ€è¦æ¯ä¸€æ¬¡é€’å½’éƒ½è¦è®°å½•å½“å‰çš„å‰¯ä½œç”¨å®ä¾‹ï¼Œåœ¨é€’å½’å®Œæˆåå°†å½“å‰çš„å‰¯ä½œç”¨å®ä¾‹å›é€€</p><p><code>initDepMarkers</code> å’Œ <code>finalizeDepMarkers</code> è¿™é‡Œçš„é€»è¾‘æ˜¯å¯¹æ¸…ç©ºä¾èµ–çš„é€»è¾‘è¿›è¡Œä¼˜åŒ–ï¼Œæ¯æ¬¡æ›´æ–°è§†å›¾éƒ½éœ€è¦æ¸…ç©ºä¾èµ–ï¼Œåå†å‰¯ä½œç”¨å‡½æ•°ä¸­åœ¨æ·»åŠ ä¾èµ–ï¼Œå¦‚æœæ›´æ–°è§†å›¾æ²¡æœ‰ä¾èµ–å˜åŒ–ï¼Œè¿™æ ·å°±æœ‰å¾ˆå¤šé¢å¤–çš„å¼€é”€ï¼Œå› æ­¤ <code>initDepMarkers</code> å‡½æ•°å°†ç°æœ‰çš„ä¾èµ–æ”¶é›†å™¨ï¼ˆdepï¼‰è¿›è¡Œæ ‡è®°ï¼Œç„¶åæ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°è¿›è¡Œä¾èµ–æ”¶é›†ï¼ˆæ ‡è®°çš„æ”¶é›†å™¨è·³è¿‡æ”¶é›†ï¼‰ï¼Œä¹‹åé€šè¿‡ <code>finalizeDepMarkers</code> å‡½æ•°åˆ é™¤æ›´æ–°åæ²¡æœ‰çš„ä¾èµ–ï¼Œå¹¶åˆ é™¤æ”¶é›†å™¨çš„æ ‡è®°</p><p><code>effectTrackDepth</code> æ˜¯è®°å½•ç»„ä»¶åµŒå¥—å±‚æ•°ï¼Œ<code>maxMarkerBits</code> æ˜¯ç»„ä»¶æœ€å¤§åµŒå¥—å±‚æ•°ï¼Œå¦‚æœç»„ä»¶å±‚æ•°å¤§äºè¿™ä¸ªæœ€å¤§åµŒå¥—å±‚æ•°åˆ™ç›´æ¥æ¸…ç©ºä¾èµ–ï¼Œå¦‚æœç»„ä»¶åµŒå¥—è¿‡æ·±åˆ™æ¸…ç©ºä¾èµ–åè€Œæ€§èƒ½æ›´å¥½ï¼Œé»˜è®¤ä¸º30</p><p>åœ¨è°ƒç”¨ <code>trackEffects</code> å‡½æ•°æ”¶é›†ä¾èµ–çš„æ—¶å€™ä¹Ÿä¼šå¯¹æ ‡è®°çš„ä¾èµ–ä¸è¿›è¡Œæ”¶é›†</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trackEffects</span><span class="token punctuation">(</span>
  dep<span class="token operator">:</span> Dep<span class="token punctuation">,</span>
  debuggerEventExtraInfo<span class="token operator">?</span><span class="token operator">:</span> DebuggerEventExtraInfo
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> shouldTrack <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTrackDepth <span class="token operator">&lt;=</span> maxMarkerBits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">newTracked</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœè¯¥æ”¶é›†å™¨æ˜¯ä¸€ä¸ªæ—§æ”¶é›†å™¨ï¼Œä¹Ÿå°±æ˜¯è¢«æ ‡è®°çš„</span>
      dep<span class="token punctuation">.</span>n <span class="token operator">|=</span> trackOpBit <span class="token comment">// set newly tracked</span>
      <span class="token comment">// åˆ¤æ–­è¯¥ä¾èµ–æ˜¯å¦éœ€è¦è¢«æ”¶é›†</span>
      shouldTrack <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">wasTracked</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Full cleanup mode.</span>
    shouldTrack <span class="token operator">=</span> <span class="token operator">!</span>dep<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>activeEffect<span class="token operator">!</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token operator">!</span><span class="token punctuation">)</span>
    activeEffect<span class="token operator">!</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>trackEffects</code> å‡½æ•°å¯¹æ”¶é›†å™¨åšäº†æ˜¯å¦éœ€è¦æ”¶é›†çš„åˆ¤æ–­</p><h2 id="readonly-api" tabindex="-1"><a class="header-anchor" href="#readonly-api" aria-hidden="true">#</a> Readonly API</h2><p>ä½¿ç”¨ <code>readonly</code> å‡½æ•°ä¼ å…¥ä¸€ä¸ªå¯¹è±¡æˆ–å“åº”å¼å¯¹è±¡ï¼Œä¼šç»™ä¼ å…¥å¯¹è±¡å¢åŠ åªè¯»é™åˆ¶ã€‚æˆ‘ä»¬ä»å…¥å£åˆ†æå…¶å®ç°</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token keyword">readonly</span><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  target<span class="token operator">:</span> <span class="token constant">T</span>
<span class="token punctuation">)</span><span class="token operator">:</span> DeepReadonly<span class="token operator">&lt;</span>UnwrapNestedRefs<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> readonlyHandlers<span class="token punctuation">,</span> readonlyCollectionHandlers<span class="token punctuation">,</span> readonlyMap<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>
  target<span class="token operator">:</span> Target<span class="token punctuation">,</span>
  isReadonly<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  baseHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  collectionHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  proxyMap<span class="token operator">:</span> WeakMap<span class="token operator">&lt;</span>Target<span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// reactiveæ–¹æ³•å¿…é¡»æ¥å—ä¸€ä¸ªå¯¹è±¡æˆ–æ•°ç»„ç±»å‹å³ typeof target === &#39;object&#39;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    target<span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">RAW</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token punctuation">(</span>isReadonly <span class="token operator">&amp;&amp;</span> target<span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœå·²ç»æ˜¯ä¸€ä¸ªå“åº”å¼å¯¹è±¡ç›´æ¥è¿”å›ï¼Œé™¤äº†è¯¥å“åº”å¼å¯¹è±¡æ˜¯åªè¯»çš„ï¼Œå› ä¸ºåªè¯»éœ€è¦å¯¹getteråšå¤„ç†</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>
  <span class="token comment">// åˆ¤æ–­ä¼ å…¥å¯¹è±¡æ˜¯å¦åœ¨ä»£ç†ç¼“å­˜ä¸­ï¼Œå¦‚æœå­˜åœ¨ç›´æ¥è¿”å›  </span>
  <span class="token keyword">const</span> existingProxy <span class="token operator">=</span> proxyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>existingProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> existingProxy
  <span class="token punctuation">}</span>
  <span class="token comment">// è·å–ä¼ å…¥å¯¹è±¡ç±»å‹ï¼ŒINVALIDè¡¨ç¤ºæ•°æ®ä¸å¯æ‹“å±•ï¼ˆä¸èƒ½æ·»åŠ æ–°å±æ€§ï¼‰ï¼ŒCOLLECTIONè¡¨ç¤ºæ•°æ®ä¸ºMapã€Setç±»å‹</span>
  <span class="token keyword">const</span> targetType <span class="token operator">=</span> <span class="token function">getTargetType</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>targetType <span class="token operator">===</span> TargetType<span class="token punctuation">.</span><span class="token constant">INVALID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿™é‡Œå¦‚æœä¼ å…¥æ•°æ®æ˜¯ä¸å¯æ‹“å±•çš„ç±»å‹åˆ™ç›´æ¥è¿”å›</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>
  <span class="token comment">// åˆ›å»ºä¼ å…¥å¯¹è±¡çš„ä»£ç†ï¼Œæ ¹æ®ä¼ å…¥å¯¹è±¡çš„ç±»å‹é€‰ç”¨ä¸åŒçš„é…ç½®</span>
  <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>
    target<span class="token punctuation">,</span>
    targetType <span class="token operator">===</span> TargetType<span class="token punctuation">.</span><span class="token constant">COLLECTION</span> <span class="token operator">?</span> collectionHandlers <span class="token operator">:</span> baseHandlers
  <span class="token punctuation">)</span>
  <span class="token comment">// è®°å…¥ç¼“å­˜</span>
  proxyMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span>
  <span class="token keyword">return</span> proxy
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>createReactiveObject</code> å‡½æ•°çš„ <code>isReadonly</code> å‚æ•°åªæ˜¯åœ¨ä¼ å…¥å“åº”å¼å¯¹è±¡ä¸”éœ€è¦é…ç½®åªè¯»çš„æ—¶å€™èµ°ä»£ç†é€»è¾‘</p><p>å’Œ <code>Reactive API</code> ä¸åŒçš„æ˜¯ä¼ å…¥çš„ä»£ç†é…ç½®ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬åªåˆ†ææ™®é€šå¯¹è±¡æ•°ç»„çš„é…ç½®ï¼Œä¹Ÿå°±æ˜¯ <code>baseHandlers</code> å‚æ•°ï¼Œ<code>Reactive API</code> ä¼ å…¥çš„æ˜¯ <code>mutableHandlers</code> é…ç½®ï¼Œè€Œ <code>Readonly API</code> ä¼ å…¥çš„æ˜¯ <code>readonlyHandlers</code> é…ç½®</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> readonlyHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>object<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// readonlyä¸éœ€è¦æ”¶é›†ä¾èµ–ï¼Œæ‰€ä»¥åªæœ‰getã€setã€deleteProertyè®¾ç½®</span>
  <span class="token comment">// å…¶ä¸­setã€deleteProertyå¹¶æ²¡æœ‰æ“ä½œå¯¹è±¡</span>
  get<span class="token operator">:</span> readonlyGet<span class="token punctuation">,</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">deleteProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å› ä¸º <code>readonly</code> æ˜¯åªè¯»çš„æ— æ³•èµ‹å€¼ï¼Œæ‰€ä»¥ä¸éœ€è¦æ”¶é›†ä¾èµ–ï¼Œä¹Ÿå°±ä¸éœ€è¦é‡å†™ <code>has</code>ã€<code>ownkeys</code> é…ç½®</p><p>å› ä¸ºæ— æ³•èµ‹å€¼è¿™é‡Œ <code>set</code>ã€<code>deleteProperty</code> å¹¶æ²¡æœ‰æ“ä½œ <code>target</code></p><p><code>get</code> é…ç½®æ˜¯ä» <code>readonlyGet</code> å˜é‡è·å¾—ï¼Œæˆ‘ä»¬é‡ç‚¹åˆ†æ</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">const</span> readonlyGet <span class="token operator">=</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">createGetter</span><span class="token punctuation">(</span>isReadonly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> shallow <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token operator">:</span> Target<span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span> receiver<span class="token operator">:</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¤„ç†è¯¥æ•°æ®çš„æè¿°å±æ€§</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ˜¯å¦æ˜¯å“åº”å¼</span>
      <span class="token keyword">return</span> <span class="token operator">!</span>isReadonly
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_READONLY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ˜¯å¦æ˜¯åªè¯»ï¼Œè¿™é‡Œçš„åªè¯»å’Œå“åº”å¼æ˜¯äº’æ–¥çš„</span>
      <span class="token keyword">return</span> isReadonly
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_SHALLOW</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ˜¯å¦æ˜¯æµ…å“åº”å¼</span>
      <span class="token keyword">return</span> shallow
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
      key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">RAW</span> <span class="token operator">&amp;&amp;</span>
      receiver <span class="token operator">===</span>
        <span class="token punctuation">(</span>isReadonly
          <span class="token operator">?</span> shallow
            <span class="token operator">?</span> shallowReadonlyMap
            <span class="token operator">:</span> readonlyMap
          <span class="token operator">:</span> shallow
          <span class="token operator">?</span> shallowReactiveMap
          <span class="token operator">:</span> reactiveMap
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ˜¯å¦æ˜¯åŸç”Ÿæ•°æ®ï¼ˆå°±æ˜¯è¢«ä»£ç†çš„æ•°æ®ï¼‰</span>
      <span class="token keyword">return</span> target
    <span class="token punctuation">}</span>

    <span class="token comment">// åˆ¤æ–­æ˜¯å¦ä¸ºæ•°ç»„</span>
    <span class="token keyword">const</span> targetIsArray <span class="token operator">=</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isReadonly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// é‡å†™ä¸€äº›æ•°ç»„ç›¸å…³æ–¹æ³•ï¼Œç”¨äºæ”¶é›†ä¾èµ–</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è·å–è®¿é—®å±æ€§çš„å€¼</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSymbol</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">?</span> builtInSymbols<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">isNonTrackableKeys</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœè®¿é—®çš„æ˜¯å†…ç½®çš„symbol key æˆ–æ˜¯ __proto__ã€__v_isRefã€__isVueå±æ€§åˆ™ç›´æ¥è¿”å›</span>
      <span class="token keyword">return</span> res
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isReadonly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœä¸æ˜¯åªè¯»å±æ€§åˆ™è¿›è¡Œä¾èµ–æ”¶é›†</span>
      <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœæ˜¯å¯¹è±¡æœ‰ä¸¤ä¸ªå¤„ç†æƒ…å†µï¼Œå¦‚æœæ˜¯åªè¯»åˆ™èµ°åªè¯»é€»è¾‘ï¼Œå¦åˆ™é€’å½’è®¿é—®å±æ€§çš„å€¼è¿›è¡Œä¾èµ–æ”¶é›†</span>
      <span class="token keyword">return</span> isReadonly <span class="token operator">?</span> <span class="token keyword">readonly</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> res
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¹‹å‰åœ¨ <code>Reactive API</code> åˆ†æäº† <code>createGetter</code> å‡½æ•°ï¼Œ<code>Readonly API</code> ä¸åŒçš„æ˜¯ä¼ å…¥å‡½æ•°å‚æ•° <code>isReadonly</code> ä¸ºtrueï¼Œçœç•¥ä¸€äº›ä¸ç›¸å…³é€»è¾‘å¯ä»¥çœ‹åˆ°ï¼Œè·å–ä¸€äº›å†…ç½®å±æ€§çš„é€»è¾‘å’Œ <code>Reactive API</code> ä¸€è‡´ï¼Œreadonlyé¿å¼€äº†æ‰€æœ‰ä¾èµ–æ”¶é›†çš„é€»è¾‘ï¼Œæœ€åå¦‚æœ <code>isReadonly</code> ä¸ºtrueåˆ™é€’å½’å°†å­å±æ€§ä¹Ÿå˜æˆåªè¯»</p><blockquote><p>readonlyçš„å±æ€§ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤ä¸éœ€è¦æ”¶é›†ä¾èµ–è§¦å‘è§†å›¾æ›´æ–°</p></blockquote><h2 id="ref-api" tabindex="-1"><a class="header-anchor" href="#ref-api" aria-hidden="true">#</a> Ref API</h2><p>é€šè¿‡ <code>Reactive API</code> è·å–å“åº”å¼å¯¹è±¡æ—¶åªèƒ½ä¼ å…¥ä¸€ä¸ªObjectç±»å‹ï¼Œå¦‚æœéœ€è¦ä¸€äº›åŸºæœ¬æ•°æ®ç±»å‹åˆ™éœ€è¦å°†åŸºæœ¬æ•°æ®é€šè¿‡å¯¹è±¡åŒ…è£¹ï¼Œè¿™æ ·éå¸¸éº»çƒ¦ï¼Œvue3æä¾›äº† <code>Ref API</code> åœ¨reactiveçš„åŸºç¡€ä¸Šå…¼å®¹åŸºæœ¬æ•°æ®ç±»å‹</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ref</span><span class="token punctuation">(</span>value<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createRef</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createRef</span><span class="token punctuation">(</span>rawValue<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span> shallow<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>rawValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> rawValue
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RefImpl</span><span class="token punctuation">(</span>rawValue<span class="token punctuation">,</span> shallow<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœ <code>ref</code> å‡½æ•°ä¼ å…¥äº†ä¸€ä¸ªrefå¯¹è±¡åˆ™ç›´æ¥è¿”å›ï¼Œæœ€åè¿”å› <code>RefImpl</code> å®ä¾‹</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">RefImpl<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> _value<span class="token operator">:</span> <span class="token constant">T</span> <span class="token comment">// ä¼ å…¥æ•°æ®</span>
  <span class="token keyword">private</span> _rawValue<span class="token operator">:</span> <span class="token constant">T</span> <span class="token comment">// ä¼ å…¥æ•°æ®çš„åŸå§‹å€¼ï¼Œå› ä¸ºå¯èƒ½ä¼ å…¥ä¸€ä¸ªreactiveæˆ–readonlyå¯¹è±¡</span>

  <span class="token keyword">public</span> dep<span class="token operator">?</span><span class="token operator">:</span> Dep <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token comment">// ä¾èµ–æ”¶é›†å™¨</span>
  <span class="token keyword">public</span> <span class="token keyword">readonly</span> __v_isRef <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// refæ ‡è¯†</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> <span class="token keyword">public</span> <span class="token keyword">readonly</span> __v_isShallow<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æµ…ä»£ç†åˆ™ç›´æ¥èµ‹å€¼</span>
    <span class="token comment">// toRaw æ•°æ®åŸå§‹å€¼</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_rawValue <span class="token operator">=</span> __v_isShallow <span class="token operator">?</span> value <span class="token operator">:</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token comment">// toReactive å¦‚æœä¼ å…¥å¯¹è±¡åˆ™è¿”å›reactiveå¯¹è±¡</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> __v_isShallow <span class="token operator">?</span> value <span class="token operator">:</span> <span class="token function">toReactive</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ”¶é›†ä¾èµ–</span>
    <span class="token function">trackRefValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­èµ‹å€¼å¯¹è±¡æ˜¯å¦ä¸ºæµ…ä»£ç†æˆ–åªè¯»</span>
    <span class="token keyword">const</span> useDirectValue <span class="token operator">=</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>__v_isShallow <span class="token operator">||</span> <span class="token function">isShallow</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isReadonly</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>
    <span class="token comment">// å¦‚æœæ˜¯æµ…ä»£ç†æˆ–åªè¯»åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™è·å–åŸæ•°æ®ï¼Œå¯èƒ½èµ‹å€¼ä¸€ä¸ªreactiveå¯¹è±¡</span>
    newVal <span class="token operator">=</span> useDirectValue <span class="token operator">?</span> newVal <span class="token operator">:</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasChanged</span><span class="token punctuation">(</span>newVal<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rawValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœæ–°æ—§ä¸¤ä¸ªå€¼ä¸ç›¸ç­‰ newVal !== this._rawValue</span>
      <span class="token comment">// æ›´æ–°åŸæ•°æ®</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_rawValue <span class="token operator">=</span> newVal
      <span class="token comment">// æ›´æ–°æ•°æ®ï¼Œå¦‚æœæ˜¯æµ…ä»£ç†ã€åªè¯»ã€éå¯¹è±¡åˆ™ç›´æ¥èµ‹å€¼ï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªreactiveå¯¹è±¡</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> useDirectValue <span class="token operator">?</span> newVal <span class="token operator">:</span> <span class="token function">toReactive</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>
      <span class="token comment">// æ´¾å‘æ›´æ–°</span>
      <span class="token function">triggerRefValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> toReactive <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">unknown</span></span><span class="token operator">&gt;</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">=&gt;</span>
  <span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">:</span> value
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>RefImpl</code> å®šä¹‰äº†æ•°æ®å¤„ç†ï¼ˆ_valueã€_rawValueï¼‰ã€ä¾èµ–æ”¶é›†ï¼ˆdepï¼‰ã€æ ‡è¯†ï¼ˆ__v_isRefï¼‰å±æ€§</p><p>åˆå§‹åŒ–é˜¶æ®µå¯ä»¥çœ‹åˆ°å¦‚æœä¼ å…¥çš„æ•°æ® <code>value</code> æ˜¯ä¸€ä¸ªObjectç±»å‹åˆ™å°†è¯¥æ•°æ®è½¬åŒ–ä¸ºreactiveå¯¹è±¡ï¼Œå¦åˆ™ç›´æ¥èµ‹å€¼åŸæ•°æ®ã€‚ä¾èµ–æ”¶é›†æ›´æ–°é€»è¾‘å’Œreactiveç±»ä¼¼ï¼Œä½†æ˜¯è¿›è¡Œäº†å°è£…ï¼Œæˆ‘ä»¬å…·ä½“å…³æ³¨ä¸‹ <code>trackRefValue</code> å’Œ <code>triggerRefValue</code> çš„å‡½æ•°å°è£…</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trackRefValue</span><span class="token punctuation">(</span>ref<span class="token operator">:</span> RefBase<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrack <span class="token operator">&amp;&amp;</span> activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–åŸå§‹æ•°æ®ï¼Œå…¶å®è¿˜æ˜¯refæœ¬èº«</span>
    ref <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span>
    <span class="token comment">// ä¼ å…¥ref.depå±æ€§è¿›è¡Œä¾èµ–æ”¶é›†</span>
    <span class="token function">trackEffects</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span>dep <span class="token operator">||</span> <span class="token punctuation">(</span>ref<span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token function">createDep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">triggerRefValue</span><span class="token punctuation">(</span>ref<span class="token operator">:</span> RefBase<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> newVal<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// è·å–åŸå§‹æ•°æ®ï¼Œå…¶å®è¿˜æ˜¯refæœ¬èº«</span>
  ref <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token punctuation">.</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ›´æ–°ref.depä¸Šçš„ä¾èµ–</span>
    <span class="token function">triggerEffects</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span>dep<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ° <code>trackRefValue</code> å’Œ <code>triggerRefValue</code> å‡½æ•°åªæ˜¯é’ˆå¯¹ <code>RefImpl</code> å®ä¾‹çš„ç‰¹æ€§è¿›è¡Œå°è£…ï¼Œå’Œreactiveä¸åŒçš„æ˜¯reactiveæ˜¯ç»´æŠ¤ä¸€ä¸ªå…¨å±€çš„ <code>targetMap</code> è¡¨ï¼Œè€Œrefæ˜¯å°†ä¾èµ–æŒ‚è½½åˆ°å®ä¾‹ä¸Šï¼Œå®é™…ä¸Šéƒ½æ˜¯é€šè¿‡è°ƒç”¨ <code>trackEffects</code> å’Œ <code>triggerEffects</code> å‡½æ•°è¿›è¡Œä¾èµ–æ”¶é›†æ›´æ–°</p><h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h2><p>è¿™ç« äº†è§£äº†å“åº”å¼çš„åŸç†ï¼Œä¾èµ–æ”¶é›†ã€æ´¾å‘æ›´æ–°ã€å‰¯ä½œç”¨å‡½æ•°ä»¥åŠé’ˆå¯¹å“åº”å¼çš„ä¸€äº›APIï¼Œè¿™äº›APIåˆ†åˆ«æœ‰å¯¹åº”çš„ä½¿ç”¨åœºæ™¯ï¼Œé€šè¿‡ä¸‹é¢çš„å›¾æ›´å¥½çš„ç†è§£å“åº”å¼çš„æµç¨‹</p><p><img src="/note/assets/reactive.0937635b.png" alt=""></p><p>è¿™å’Œvue2.xçš„å“åº”å¼ç±»ä¼¼ï¼Œä¸»è¦æ˜¯å°†Object.definePropertyæ›¿æ¢æˆProxyå®ç°å“åº”å¼ï¼Œä»¥åŠå°†Watcherå®ä¾‹æ›¿æ¢æˆå‰¯ä½œç”¨å®ä¾‹</p></div><!----><footer class="page-meta"><!----><div class="meta-item update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="meta-item contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: marx10086@gmail.com">marx</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/note/vue3%E6%BA%90%E7%A0%81/3.setup.html" class="nav-link prev" aria-label="setupï¼ˆç»„ä»¶åˆå§‹åŒ–ï¼‰"><div class="hint"><span class="arrow left"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->setupï¼ˆç»„ä»¶åˆå§‹åŒ–ï¼‰</div></a><a href="/note/vue3%E6%BA%90%E7%A0%81/5.%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7.html" class="nav-link next" aria-label="è®¡ç®—å±æ€§"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow right"></span></div><div class="link">è®¡ç®—å±æ€§<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/note/assets/app.002a81c8.js" defer></script>
  </body>
</html>
